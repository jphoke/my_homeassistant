globals:
  - id: display_page
    type: int
    restore_value: true
    initial_value: '0'
  - id: page_refresh_default_s
    type: int
    restore_value: true
    initial_value: '600'
  - id: page_refresh_current_s
    type: int
    restore_value: false
    initial_value: '60'
  - id: last_page_switch_time
    type: uint32_t
    restore_value: false
    initial_value: '0'
psram:
  mode: octal
  speed: 80MHz
http_request:
  verify_ssl: false
  timeout: 20s
  buffer_size_rx: 4096
i2c:
  - sda: GPIO19
    scl: GPIO20
    scan: true
    id: bus_a
spi:
  - id: spi_bus
    clk_pin: GPIO7
    mosi_pin: GPIO9
output:
  - platform: gpio
    pin: GPIO21
    id: bsp_battery_enable
  - platform: ledc
    pin: GPIO45
    id: buzzer_output
rtttl:
  id: reterminal_buzzer
  output: buzzer_output
time:
  - platform: homeassistant
    id: ha_time
sensor:
  - platform: adc
    pin: GPIO1
    name: "Battery Voltage"
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    id: battery_voltage
    update_interval: 60s
    attenuation: 12db
    filters:
      - multiply: 2
  - platform: sht4x
    id: sht4x_sensor
    temperature:
      name: "Temperature"
      id: sht4x_temperature
    humidity:
      name: "Humidity"
      id: sht4x_humidity
    address: 0x44
    update_interval: 60s
  - platform: template
    name: "Battery Level"
    id: battery_level
    unit_of_measurement: "%"
    icon: "mdi:battery"
    device_class: battery
    state_class: measurement
    lambda: |-
      if (id(battery_voltage).state > 4.15) return 100;
      if (id(battery_voltage).state < 3.27) return 0;
      return (id(battery_voltage).state - 3.27) / (4.15 - 3.27) * 100.0;
  - platform: wifi_signal
    name: "WiFi Signal"
    id: wifi_signal_dbm
    update_interval: 60s
  - platform: homeassistant
    id: sensor_test_progress
    entity_id: sensor.test_progress
    internal: true
  - platform: homeassistant
    id: sensor_test_temp
    entity_id: sensor.test_temp
    internal: true
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO5
      mode: INPUT_PULLUP
      inverted: true
    name: "Left Button"
    id: button_left
    on_press:
      then:
        - script.execute:
            id: change_page_to
            target_page: !lambda 'return id(display_page) > 0 ? id(display_page) - 1 : 0;'
  - platform: gpio
    pin:
      number: GPIO4
      mode: INPUT_PULLUP
      inverted: true
    name: "Right Button"
    id: button_right
    on_press:
      then:
        - script.execute:
            id: change_page_to
            target_page: !lambda 'return id(display_page) < 0 ? id(display_page) + 1 : 0;'
  - platform: gpio
    pin:
      number: GPIO3
      mode: INPUT_PULLUP
      inverted: true
    name: "Refresh Button"
    id: button_refresh
    on_press:
      then:
        - component.update: epaper_display
  - platform: gpio
    pin:
      number: GPIO2
      mode: INPUT_PULLUP
      inverted: true
    name: "Home Button"
    id: button_home
    on_press:
      then:
        - script.execute:
            id: change_page_to
            target_page: 0
        - script.execute: manage_run_and_sleep
button:
  - platform: template
    name: "Next Page"
    on_press:
      then:
        - script.execute:
            id: change_page_to
            target_page: !lambda 'return id(display_page) + 1;'
  - platform: template
    name: "Previous Page"
    on_press:
      then:
        - script.execute:
            id: change_page_to
            target_page: !lambda 'return id(display_page) - 1;'
  - platform: template
    name: "Refresh Display"
    on_press:
      then:
        - component.update: epaper_display
  - platform: template
    name: "Go to Page 1"
    on_press:
      then:
        - script.execute:
            id: change_page_to
            target_page: 0
  - platform: template
    name: "Play Beep Short"
    icon: "mdi:bell-ring"
    on_press:
      - rtttl.play: "beep:d=32,o=5,b=200:16e6"
  - platform: template
    name: "Play Beep OK"
    icon: "mdi:check-circle-outline"
    on_press:
      - rtttl.play: "ok:d=16,o=5,b=200:e6"
  - platform: template
    name: "Play Beep Error"
    icon: "mdi:alert-circle-outline"
    on_press:
      - rtttl.play: "error:d=16,o=5,b=200:c6"
  - platform: template
    name: "Play Star Wars"
    icon: "mdi:music-note"
    on_press:
      - rtttl.play: "StarWars:d=4,o=5,b=45:32p,32f,32f,32f,8a#.,8f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32d#,8c6"
image:
  - file: "test_image.png"
    id: img_test_image_png_50x50
    type: BINARY
    resize: 50x50
    dither: FLOYDSTEINBERG
graph:
  - id: graph_w_graph
    duration: 1h
    width: 200
    height: 100
    border: true
    x_grid: 15min
    y_grid: 50
    traces:
      - sensor: sensor_test_temp
        line_thickness: 3
font:
  - file:
      type: gfonts
      family: "Roboto"
      weight: 400
      italic: false
    id: font_roboto_400_12
    size: 12
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002A", "\U0000002B", "\U0000002C", "\U0000002D", "\U0000002E", "\U0000002F", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003A", "\U0000003B", "\U0000003C", "\U0000003D", "\U0000003E", "\U0000003F", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004A", "\U0000004B", "\U0000004C", "\U0000004D", "\U0000004E", "\U0000004F", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005A", "\U0000005B", "\U0000005C", "\U0000005D", "\U0000005E", "\U0000005F", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006A", "\U0000006B", "\U0000006C", "\U0000006D", "\U0000006E", "\U0000006F", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007A", "\U0000007B", "\U0000007C", "\U0000007D", "\U0000007E", "\U000000A0", "\U000000A1", "\U000000A2", "\U000000A3", "\U000000A4", "\U000000A5", "\U000000A6", "\U000000A7", "\U000000A8", "\U000000A9", "\U000000AA", "\U000000AB", "\U000000AC", "\U000000AD", "\U000000AE", "\U000000AF", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B4", "\U000000B5", "\U000000B6", "\U000000B7", "\U000000B8", "\U000000B9", "\U000000BA", "\U000000BB", "\U000000BC", "\U000000BD", "\U000000BE", "\U000000BF", "\U000000C0", "\U000000C1", "\U000000C2", "\U000000C3", "\U000000C4", "\U000000C5", "\U000000C6", "\U000000C7", "\U000000C8", "\U000000C9", "\U000000CA", "\U000000CB", "\U000000CC", "\U000000CD", "\U000000CE", "\U000000CF", "\U000000D0", "\U000000D1", "\U000000D2", "\U000000D3", "\U000000D4", "\U000000D5", "\U000000D6", "\U000000D7", "\U000000D8", "\U000000D9", "\U000000DA", "\U000000DB", "\U000000DC", "\U000000DD", "\U000000DE", "\U000000DF", "\U000000E0", "\U000000E1", "\U000000E2", "\U000000E3", "\U000000E4", "\U000000E5", "\U000000E6", "\U000000E7", "\U000000E8", "\U000000E9", "\U000000EA", "\U000000EB", "\U000000EC", "\U000000ED", "\U000000EE", "\U000000EF", "\U000000F0", "\U000000F1", "\U000000F2", "\U000000F3", "\U000000F4", "\U000000F5", "\U000000F6", "\U000000F7", "\U000000F8", "\U000000F9", "\U000000FA", "\U000000FB", "\U000000FC", "\U000000FD", "\U000000FE", "\U000000FF", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file:
      type: gfonts
      family: "Roboto"
      weight: 700
      italic: false
    id: font_roboto_700_28
    size: 28
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002A", "\U0000002B", "\U0000002C", "\U0000002D", "\U0000002E", "\U0000002F", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003A", "\U0000003B", "\U0000003C", "\U0000003D", "\U0000003E", "\U0000003F", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004A", "\U0000004B", "\U0000004C", "\U0000004D", "\U0000004E", "\U0000004F", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005A", "\U0000005B", "\U0000005C", "\U0000005D", "\U0000005E", "\U0000005F", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006A", "\U0000006B", "\U0000006C", "\U0000006D", "\U0000006E", "\U0000006F", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007A", "\U0000007B", "\U0000007C", "\U0000007D", "\U0000007E", "\U000000A0", "\U000000A1", "\U000000A2", "\U000000A3", "\U000000A4", "\U000000A5", "\U000000A6", "\U000000A7", "\U000000A8", "\U000000A9", "\U000000AA", "\U000000AB", "\U000000AC", "\U000000AD", "\U000000AE", "\U000000AF", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B4", "\U000000B5", "\U000000B6", "\U000000B7", "\U000000B8", "\U000000B9", "\U000000BA", "\U000000BB", "\U000000BC", "\U000000BD", "\U000000BE", "\U000000BF", "\U000000C0", "\U000000C1", "\U000000C2", "\U000000C3", "\U000000C4", "\U000000C5", "\U000000C6", "\U000000C7", "\U000000C8", "\U000000C9", "\U000000CA", "\U000000CB", "\U000000CC", "\U000000CD", "\U000000CE", "\U000000CF", "\U000000D0", "\U000000D1", "\U000000D2", "\U000000D3", "\U000000D4", "\U000000D5", "\U000000D6", "\U000000D7", "\U000000D8", "\U000000D9", "\U000000DA", "\U000000DB", "\U000000DC", "\U000000DD", "\U000000DE", "\U000000DF", "\U000000E0", "\U000000E1", "\U000000E2", "\U000000E3", "\U000000E4", "\U000000E5", "\U000000E6", "\U000000E7", "\U000000E8", "\U000000E9", "\U000000EA", "\U000000EB", "\U000000EC", "\U000000ED", "\U000000EE", "\U000000EF", "\U000000F0", "\U000000F1", "\U000000F2", "\U000000F3", "\U000000F4", "\U000000F5", "\U000000F6", "\U000000F7", "\U000000F8", "\U000000F9", "\U000000FA", "\U000000FB", "\U000000FC", "\U000000FD", "\U000000FE", "\U000000FF", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file:
      type: gfonts
      family: "Roboto"
      weight: 400
      italic: false
    id: font_roboto_400_16
    size: 16
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002A", "\U0000002B", "\U0000002C", "\U0000002D", "\U0000002E", "\U0000002F", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003A", "\U0000003B", "\U0000003C", "\U0000003D", "\U0000003E", "\U0000003F", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004A", "\U0000004B", "\U0000004C", "\U0000004D", "\U0000004E", "\U0000004F", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005A", "\U0000005B", "\U0000005C", "\U0000005D", "\U0000005E", "\U0000005F", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006A", "\U0000006B", "\U0000006C", "\U0000006D", "\U0000006E", "\U0000006F", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007A", "\U0000007B", "\U0000007C", "\U0000007D", "\U0000007E", "\U000000A0", "\U000000A1", "\U000000A2", "\U000000A3", "\U000000A4", "\U000000A5", "\U000000A6", "\U000000A7", "\U000000A8", "\U000000A9", "\U000000AA", "\U000000AB", "\U000000AC", "\U000000AD", "\U000000AE", "\U000000AF", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B4", "\U000000B5", "\U000000B6", "\U000000B7", "\U000000B8", "\U000000B9", "\U000000BA", "\U000000BB", "\U000000BC", "\U000000BD", "\U000000BE", "\U000000BF", "\U000000C0", "\U000000C1", "\U000000C2", "\U000000C3", "\U000000C4", "\U000000C5", "\U000000C6", "\U000000C7", "\U000000C8", "\U000000C9", "\U000000CA", "\U000000CB", "\U000000CC", "\U000000CD", "\U000000CE", "\U000000CF", "\U000000D0", "\U000000D1", "\U000000D2", "\U000000D3", "\U000000D4", "\U000000D5", "\U000000D6", "\U000000D7", "\U000000D8", "\U000000D9", "\U000000DA", "\U000000DB", "\U000000DC", "\U000000DD", "\U000000DE", "\U000000DF", "\U000000E0", "\U000000E1", "\U000000E2", "\U000000E3", "\U000000E4", "\U000000E5", "\U000000E6", "\U000000E7", "\U000000E8", "\U000000E9", "\U000000EA", "\U000000EB", "\U000000EC", "\U000000ED", "\U000000EE", "\U000000EF", "\U000000F0", "\U000000F1", "\U000000F2", "\U000000F3", "\U000000F4", "\U000000F5", "\U000000F6", "\U000000F7", "\U000000F8", "\U000000F9", "\U000000FA", "\U000000FB", "\U000000FC", "\U000000FD", "\U000000FE", "\U000000FF", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file:
      type: gfonts
      family: "Roboto"
      weight: 400
      italic: false
    id: font_roboto_400_14
    size: 14
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002A", "\U0000002B", "\U0000002C", "\U0000002D", "\U0000002E", "\U0000002F", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003A", "\U0000003B", "\U0000003C", "\U0000003D", "\U0000003E", "\U0000003F", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004A", "\U0000004B", "\U0000004C", "\U0000004D", "\U0000004E", "\U0000004F", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005A", "\U0000005B", "\U0000005C", "\U0000005D", "\U0000005E", "\U0000005F", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006A", "\U0000006B", "\U0000006C", "\U0000006D", "\U0000006E", "\U0000006F", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007A", "\U0000007B", "\U0000007C", "\U0000007D", "\U0000007E", "\U000000A0", "\U000000A1", "\U000000A2", "\U000000A3", "\U000000A4", "\U000000A5", "\U000000A6", "\U000000A7", "\U000000A8", "\U000000A9", "\U000000AA", "\U000000AB", "\U000000AC", "\U000000AD", "\U000000AE", "\U000000AF", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B4", "\U000000B5", "\U000000B6", "\U000000B7", "\U000000B8", "\U000000B9", "\U000000BA", "\U000000BB", "\U000000BC", "\U000000BD", "\U000000BE", "\U000000BF", "\U000000C0", "\U000000C1", "\U000000C2", "\U000000C3", "\U000000C4", "\U000000C5", "\U000000C6", "\U000000C7", "\U000000C8", "\U000000C9", "\U000000CA", "\U000000CB", "\U000000CC", "\U000000CD", "\U000000CE", "\U000000CF", "\U000000D0", "\U000000D1", "\U000000D2", "\U000000D3", "\U000000D4", "\U000000D5", "\U000000D6", "\U000000D7", "\U000000D8", "\U000000D9", "\U000000DA", "\U000000DB", "\U000000DC", "\U000000DD", "\U000000DE", "\U000000DF", "\U000000E0", "\U000000E1", "\U000000E2", "\U000000E3", "\U000000E4", "\U000000E5", "\U000000E6", "\U000000E7", "\U000000E8", "\U000000E9", "\U000000EA", "\U000000EB", "\U000000EC", "\U000000ED", "\U000000EE", "\U000000EF", "\U000000F0", "\U000000F1", "\U000000F2", "\U000000F3", "\U000000F4", "\U000000F5", "\U000000F6", "\U000000F7", "\U000000F8", "\U000000F9", "\U000000FA", "\U000000FB", "\U000000FC", "\U000000FD", "\U000000FE", "\U000000FF", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file:
      type: gfonts
      family: "Roboto"
      weight: 400
      italic: false
    id: font_roboto_400_20
    size: 20
    glyphs: ["\U00000020", "\U00000021", "\U00000022", "\U00000023", "\U00000024", "\U00000025", "\U00000026", "\U00000027", "\U00000028", "\U00000029", "\U0000002A", "\U0000002B", "\U0000002C", "\U0000002D", "\U0000002E", "\U0000002F", "\U00000030", "\U00000031", "\U00000032", "\U00000033", "\U00000034", "\U00000035", "\U00000036", "\U00000037", "\U00000038", "\U00000039", "\U0000003A", "\U0000003B", "\U0000003C", "\U0000003D", "\U0000003E", "\U0000003F", "\U00000040", "\U00000041", "\U00000042", "\U00000043", "\U00000044", "\U00000045", "\U00000046", "\U00000047", "\U00000048", "\U00000049", "\U0000004A", "\U0000004B", "\U0000004C", "\U0000004D", "\U0000004E", "\U0000004F", "\U00000050", "\U00000051", "\U00000052", "\U00000053", "\U00000054", "\U00000055", "\U00000056", "\U00000057", "\U00000058", "\U00000059", "\U0000005A", "\U0000005B", "\U0000005C", "\U0000005D", "\U0000005E", "\U0000005F", "\U00000060", "\U00000061", "\U00000062", "\U00000063", "\U00000064", "\U00000065", "\U00000066", "\U00000067", "\U00000068", "\U00000069", "\U0000006A", "\U0000006B", "\U0000006C", "\U0000006D", "\U0000006E", "\U0000006F", "\U00000070", "\U00000071", "\U00000072", "\U00000073", "\U00000074", "\U00000075", "\U00000076", "\U00000077", "\U00000078", "\U00000079", "\U0000007A", "\U0000007B", "\U0000007C", "\U0000007D", "\U0000007E", "\U000000A0", "\U000000A1", "\U000000A2", "\U000000A3", "\U000000A4", "\U000000A5", "\U000000A6", "\U000000A7", "\U000000A8", "\U000000A9", "\U000000AA", "\U000000AB", "\U000000AC", "\U000000AD", "\U000000AE", "\U000000AF", "\U000000B0", "\U000000B1", "\U000000B2", "\U000000B3", "\U000000B4", "\U000000B5", "\U000000B6", "\U000000B7", "\U000000B8", "\U000000B9", "\U000000BA", "\U000000BB", "\U000000BC", "\U000000BD", "\U000000BE", "\U000000BF", "\U000000C0", "\U000000C1", "\U000000C2", "\U000000C3", "\U000000C4", "\U000000C5", "\U000000C6", "\U000000C7", "\U000000C8", "\U000000C9", "\U000000CA", "\U000000CB", "\U000000CC", "\U000000CD", "\U000000CE", "\U000000CF", "\U000000D0", "\U000000D1", "\U000000D2", "\U000000D3", "\U000000D4", "\U000000D5", "\U000000D6", "\U000000D7", "\U000000D8", "\U000000D9", "\U000000DA", "\U000000DB", "\U000000DC", "\U000000DD", "\U000000DE", "\U000000DF", "\U000000E0", "\U000000E1", "\U000000E2", "\U000000E3", "\U000000E4", "\U000000E5", "\U000000E6", "\U000000E7", "\U000000E8", "\U000000E9", "\U000000EA", "\U000000EB", "\U000000EC", "\U000000ED", "\U000000EE", "\U000000EF", "\U000000F0", "\U000000F1", "\U000000F2", "\U000000F3", "\U000000F4", "\U000000F5", "\U000000F6", "\U000000F7", "\U000000F8", "\U000000F9", "\U000000FA", "\U000000FB", "\U000000FC", "\U000000FD", "\U000000FE", "\U000000FF", "\U000003BC", "\U000003A9", "\U000020AC", "\U00002122"]
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: font_material_design_icons_400_24
    size: 24
    glyphs: ["\U000F0079", "\U000F007A", "\U000F007B", "\U000F007C", "\U000F007D", "\U000F007E", "\U000F007F", "\U000F0080", "\U000F0081", "\U000F0082", "\U000F0083", "\U000F091F", "\U000F0922", "\U000F0925", "\U000F0928", "\U000F092B"]
script:
  - id: change_page_to
    parameters:
      target_page: int
    then:
      - lambda: |-
          int pages_count = 1;
          int target = target_page;
          while (target < 0) target += pages_count;
          target %= pages_count;
          // Debounce: Ignore page changes within 3000ms of last change
          // (adjusted for e-paper display update time)
          uint32_t now = millis();
          if (now - id(last_page_switch_time) < 3000) {
            ESP_LOGD("display", "Page change ignored (debounce), last switch was %d ms ago", now - id(last_page_switch_time));
            return;
          }
          if (id(display_page) != target) {
            // Set debounce time BEFORE display update (update takes ~1.6s)
            id(last_page_switch_time) = now;
            id(display_page) = target;
            id(epaper_display).update();
            ESP_LOGI("display", "Switched to page %d", target);
            // Restart refresh logic
            if (id(manage_run_and_sleep).is_running()) id(manage_run_and_sleep).stop();
            id(manage_run_and_sleep).execute();
          }
  - id: manage_run_and_sleep
    mode: restart
    then:
      - logger.log: "Waiting for sync..."
      - wait_until:
          condition:
            lambda: 'return id(ha_time).now().is_valid() && api_is_connected();'
          timeout: 60s
      - delay: 5s
      - lambda: |-
          int p = id(display_page);
          int interval = id(page_refresh_default_s);
          bool is_sleep_time = false;
          auto time = id(ha_time).now();
          if (time.is_valid()) {
             int hour = time.hour;
             int start = 0;
             int end = 0;
             if (start < end) {
                 if (hour >= start && hour < end) is_sleep_time = true;
             } else {
                 if (hour >= start || hour < end) is_sleep_time = true;
             }
          }
          if (!is_sleep_time) {
          }
          id(page_refresh_current_s) = interval;
      - component.update: epaper_display
      - delay: !lambda 'return id(page_refresh_current_s) * 1000;'
      - script.execute: manage_run_and_sleep
display:
  - platform: waveshare_epaper
    id: epaper_display
    cs_pin: GPIO10
    dc_pin: GPIO11
    reset_pin:
      number: GPIO12
      inverted: false
    busy_pin:
      number: GPIO13
      inverted: true
    model: "7.50inv2p"
    rotation: 0
    update_interval: never
    full_update_every: 30
    lambda: |-
      const auto COLOR_WHITE = Color(0, 0, 0); // Inverted for e-ink
      const auto COLOR_BLACK = Color(255, 255, 255); // Inverted for e-ink
      const auto COLOR_RED = Color(255, 0, 0);
      const auto COLOR_GREEN = Color(0, 255, 0);
      const auto COLOR_BLUE = Color(0, 0, 255);
      const auto COLOR_YELLOW = Color(255, 255, 0);
      const auto COLOR_ORANGE = Color(255, 165, 0);
      auto color_off = COLOR_WHITE;
      auto color_on = COLOR_BLACK;
      // Helper to apply a simple grey dither mask for e-paper (checkerboard)
      auto apply_grey_dither_mask = [&](int x_start, int y_start, int w, int h) {
        for (int y = y_start; y < y_start + h; y++) {
          for (int x = x_start; x < x_start + w; x++) {
            if ((x + y) % 2 == 0) it.draw_pixel_at(x, y, COLOR_WHITE);
            else it.draw_pixel_at(x, y, COLOR_BLACK);
          }
        }
      };
      // Helper to apply grey dither to text (subtractive - erases every other black pixel)
      auto apply_grey_dither_to_text = [&](int x_start, int y_start, int w, int h) {
        for (int y = y_start; y < y_start + h; y++) {
          for (int x = x_start; x < x_start + w; x++) {
            if ((x + y) % 2 == 0) it.draw_pixel_at(x, y, COLOR_WHITE);
          }
        }
      };
      int currentPage = id(display_page);
      if (currentPage == 0) {
        // page:name "Page 1"
        // page:dark_mode "inherit"
        // page:refresh_type "interval"
        // page:refresh_time ""
        // Clear screen for this page
        it.fill(COLOR_WHITE);
        color_off = COLOR_WHITE;
        color_on = COLOR_BLACK;
        // widget:icon id:w_icon type:icon x:10 y:10 w:24 h:24 code:F0595 size:24 color:red
        it.printf(10, 10, id(font_material_design_icons_400_24), COLOR_RED, "%s", "\U000F0595");
        // widget:text id:w_label type:text x:50 y:10 w:100 h:20 text:"Golden Master Test"
        it.printf(50, 10, id(font_roboto_400_20), COLOR_BLACK, TextAlign::TOP_LEFT, "Golden Master Test");
        // widget:shape_rect id:w_rect type:shape_rect x:10 y:50 w:100 h:50 fill:true border:1 color:blue border_color:blue
        it.filled_rectangle(10, 50, 100, 50, COLOR_BLUE);
        for (int i = 0; i < 1; i++) {
          it.rectangle(10 + i, 50 + i, 100 - 2 * i, 50 - 2 * i, COLOR_BLUE);
        }
        // widget:shape_circle id:w_circle type:shape_circle x:120 y:50 w:50 h:50 fill:false border:2 color:green border_color:green
        for (int i = 0; i < 2; i++) {
          it.circle(145, 75, 25 - i, COLOR_GREEN);
        }
        // widget:line id:w_line type:line x:10 y:110 w:100 h:2 stroke:2 color:black orientation:horizontal
        it.filled_rectangle(10, 110, 100, 2, COLOR_BLACK);
        // widget:battery_icon id:w_battery type:battery_icon x:200 y:10 w:24 h:24 entity:battery_level size:24 font_size:12 color:black local:false
        {
          const char* bat_icon = "\U000F0082"; // Default: battery-90
          float bat_level = 0;
          if (id(battery_level).has_state()) {
            bat_level = id(battery_level).state;
            if (std::isnan(bat_level)) bat_level = 0;
            if (bat_level >= 95) bat_icon = "\U000F0079";      // battery (full)
            else if (bat_level >= 85) bat_icon = "\U000F0082"; // battery-90
            else if (bat_level >= 75) bat_icon = "\U000F0081"; // battery-80
            else if (bat_level >= 65) bat_icon = "\U000F0080"; // battery-70
            else if (bat_level >= 55) bat_icon = "\U000F007F"; // battery-60
            else if (bat_level >= 45) bat_icon = "\U000F007E"; // battery-50
            else if (bat_level >= 35) bat_icon = "\U000F007D"; // battery-40
            else if (bat_level >= 25) bat_icon = "\U000F007C"; // battery-30
            else if (bat_level >= 15) bat_icon = "\U000F007B"; // battery-20
            else if (bat_level >= 5) bat_icon = "\U000F007A";  // battery-10
            else bat_icon = "\U000F0083";                      // battery-alert (critical)
          }
          it.printf(200 + 24 / 2, 10 + (24 - 38) / 2, id(font_material_design_icons_400_24), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", bat_icon);
          it.printf(200 + 24 / 2, 10 + (24 - 38) / 2 + 24 + 2, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_CENTER, "%.0f%%", bat_level);
        }
        // widget:progress_bar id:w_progress type:progress_bar x:10 y:120 w:150 h:20 entity:sensor.test_progress title:"" show_label:true show_pct:true bar_height:15 color:black local:false
        float val_w_progress = id(sensor_test_progress).state;
        if (std::isnan(val_w_progress)) val_w_progress = 0;
        int pct_w_progress = (int)val_w_progress;
        if (pct_w_progress < 0) pct_w_progress = 0;
        if (pct_w_progress > 100) pct_w_progress = 100;
        it.printf(10 + 150, 120, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_RIGHT, "%d%%", pct_w_progress);
        it.rectangle(10, 125, 150, 15, COLOR_BLACK);
        if (pct_w_progress > 0) {
          int bar_w = (150 - 4) * pct_w_progress / 100;
          it.filled_rectangle(10 + 2, 125 + 2, bar_w, 15 - 4, COLOR_BLACK);
        }
        // widget:wifi_signal id:w_wifi type:wifi_signal x:240 y:10 w:24 h:24 entity:wifi_signal_dbm size:24 font_size:12 color:black show_dbm:true local:true
        {
          const char* wifi_icon = "\U000F092B"; // Default: wifi-strength-alert-outline
          if (id(wifi_signal_dbm).has_state()) {
            float signal = id(wifi_signal_dbm).state;
            if (std::isnan(signal)) signal = -100;
            if (signal >= -50) wifi_icon = "\U000F0928";      // wifi-strength-4 (Excellent)
            else if (signal >= -60) wifi_icon = "\U000F0925"; // wifi-strength-3 (Good)
            else if (signal >= -75) wifi_icon = "\U000F0922"; // wifi-strength-2 (Fair)
            else if (signal >= -100) wifi_icon = "\U000F091F"; // wifi-strength-1 (Weak)
            else wifi_icon = "\U000F092B";                    // wifi-strength-alert-outline
          }
          it.printf(240 + 24 / 2, 10 + (24 - 38) / 2, id(font_material_design_icons_400_24), COLOR_BLACK, TextAlign::TOP_CENTER, "%s", wifi_icon);
          if (id(wifi_signal_dbm).has_state()) {
            it.printf(240 + 24 / 2, 10 + (24 - 38) / 2 + 24 + 2, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_CENTER, "%.0fdB", id(wifi_signal_dbm).state);
          }
        }
        // widget:datetime id:w_datetime type:datetime x:10 y:150 w:200 h:40 fmt:time_date
        {
          auto now = id(ha_time).now();
          it.strftime(110, 147, id(font_roboto_700_28), COLOR_BLACK, TextAlign::CENTER, "%H:%M", now);
          it.strftime(110, 147 + 28 + 2, id(font_roboto_400_16), COLOR_BLACK, TextAlign::CENTER, "%a, %b %d", now);
        }
        // widget:sensor_text id:w_sensor type:sensor_text x:10 y:200 w:100 h:20 entity:"sensor.test_temp" format:"label_value"
        {
          int w, h, xoff, bl;
          id(font_roboto_400_14)->measure("test temp: ", &w, &xoff, &bl, &h);
          it.printf(10, 200, id(font_roboto_400_14), COLOR_BLACK, TextAlign::TOP_LEFT, "test temp: ");
          it.printf(10 + w, 200, id(font_roboto_400_20), COLOR_BLACK, TextAlign::TOP_LEFT, "%.2f Â°C", id(sensor_test_temp).state);
        }
        // widget:graph id:w_graph type:graph x:10 y:230 w:200 h:100 title:"" entity:sensor.test_temp local:false duration:1h border:true color:black x_grid:15min y_grid:50 line_type:SOLID line_thickness:3 continuous:false min_value: max_value: min_range: max_range:
        it.graph(10, 230, id(graph_w_graph));
        for (int i = 0; i < 3; i++) {
          it.rectangle(10 + i, 230 + i, 200 - 2 * i, 100 - 2 * i, COLOR_BLACK);
        }
        for (int i = 0; i < 200; i += 4) {
          it.draw_pixel_at(10 + i, 255, COLOR_BLACK);
        }
        for (int i = 0; i < 200; i += 4) {
          it.draw_pixel_at(10 + i, 280, COLOR_BLACK);
        }
        for (int i = 0; i < 200; i += 4) {
          it.draw_pixel_at(10 + i, 305, COLOR_BLACK);
        }
        for (int i = 0; i < 100; i += 4) {
          it.draw_pixel_at(60, 230 + i, COLOR_BLACK);
        }
        for (int i = 0; i < 100; i += 4) {
          it.draw_pixel_at(110, 230 + i, COLOR_BLACK);
        }
        for (int i = 0; i < 100; i += 4) {
          it.draw_pixel_at(160, 230 + i, COLOR_BLACK);
        }
        it.printf(10 - 4, 230 + 100 - 6, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_RIGHT, "%.0f", (float)0);
        it.printf(10 - 4, 230 + 75 - 6, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_RIGHT, "%.0f", (float)25);
        it.printf(10 - 4, 230 + 50 - 6, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_RIGHT, "%.0f", (float)50);
        it.printf(10 - 4, 230 + 25 - 6, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_RIGHT, "%.0f", (float)75);
        it.printf(10 - 4, 230 + 0 - 6, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_RIGHT, "%.0f", (float)100);
        it.printf(10 + 0, 230 + 100 + 2, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_LEFT, "-1.0h");
        it.printf(10 + 100, 230 + 100 + 2, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_CENTER, "-30m");
        it.printf(10 + 200, 230 + 100 + 2, id(font_roboto_400_12), COLOR_BLACK, TextAlign::TOP_RIGHT, "Now");
        // widget:image id:w_image type:image x:220 y:230 w:50 h:50 path:"test_image.png" invert:false
        it.image(220, 230, id(img_test_image_png_50x50), color_on, color_off);
      }