<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <script>
    // Fix for HA Sidebar disappearing on reload:
    // If we are the top window (not in iframe) but we are the editor index.html,
    // it means the user reloaded the frame directly. Redirect back to the HA panel.
    if (window.top === window.self && window.location.pathname.includes('/esphome-designer/editor/index.html')) {
      // Redirect back to the Home Assistant panel URL
      window.location.replace('/esphome-designer');
    }
  </script>

  <title>ESPHome Designer ¬∑ YAML Snippet Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts for live preview -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Inter:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700;1,800&family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&family=Nunito:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,500;1,600;1,700;1,800;1,900&family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&family=Work+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Source+Sans+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700;1,900&family=Quicksand:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="editor.css">
  <link rel="icon" href="assets/favicon.png" type="image/x-icon">
</head>

<body>
  <header class="main-header" role="banner">
    <div class="main-header-title">
      <img src="assets/logo_header.png" alt="ESPHome Designer" class="logo-image">
      <span><small style="opacity: 0.5; margin-left: 8px;">v1.0.0 RC3</small> <span id="currentLayoutDevice"
          style="margin-left:8px; color:var(--accent);"></span></span>
    </div>
    <div class="main-header-actions desktop-only">
      <a href="https://github.com/koosoli/ESPHomeDesigner/" target="_blank" class="btn btn-secondary"
        style="font-size: 11px;">
        <svg height="14" width="14" viewBox="0 0 16 16" fill="currentColor"
          style="vertical-align: middle; margin-right: 4px;">
          <path
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
        GitHub
      </a>
      <a href="https://buymeacoffee.com/koosoli" target="_blank" class="btn btn-secondary" title="Buy me a coffee">
        <span class="mdi mdi-coffee" style="font-size: 16px;"></span>
      </a>
      <button id="deviceSettingsBtn" class="btn btn-secondary">üì± Device Settings</button>
      <button id="editorSettingsBtn" class="btn btn-secondary">‚öô Editor Settings</button>
    </div>
    <div class="main-header-actions mobile-only">
      <button id="mobileWidgetsBtn" class="btn btn-secondary"><svg viewBox="0 0 24 24" width="18" height="18"
          fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg></button>
      <button id="mobileDeviceBtn" class="btn btn-secondary">üì±</button>
      <button id="mobileEditorSettingsBtn" class="btn btn-secondary">‚öô</button>
      <a href="https://buymeacoffee.com/koosoli" target="_blank" class="btn btn-secondary" title="Buy me a coffee">
        <span class="mdi mdi-coffee" style="font-size: 18px;"></span>
      </a>
      <button id="mobilePropsBtn" class="btn btn-secondary"><svg viewBox="0 0 24 24" width="18" height="18" fill="none"
          stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
          </path>
        </svg></button>
    </div>
  </header>

  <div id="mobileBackdrop" class="mobile-backdrop"></div>

  <div class="app-content">
    <aside class="sidebar" role="complementary" aria-label="Editor Sidebar">
      <div id="pagesSection" class="sidebar-section collapsible expanded">
        <div class="sidebar-section-label" id="pagesHeader"
          style="padding: 12px 16px 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; border-radius: 4px;"
          title="Click to view all pages">
          <div style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
            </svg>
            <span style="font-weight: 600;">PAGES</span>
          </div>
          <svg class="chevron" viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor"
            stroke-width="3" style="transition: transform 0.2s; transform: rotate(0deg);">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>

        <div id="pagesContent" class="collapsible-content" style="padding: 0 16px 12px;">
          <div id="pageList" class="page-list"></div>
          <button id="addPageBtn" class="btn btn-secondary btn-full" style="margin-top: 8px;">+ Add page</button>
          <button id="clearAllBtn" class="btn btn-secondary btn-full" style="margin-top: 4px;"
            title="Remove all widgets from current page">Clear Current Page</button>
        </div>
      </div>

      <div class="sidebar-section" style="flex: 1; overflow-y: auto;">
        <div class="sidebar-section-label" style="display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
            <span>Widgets</span>
          </div>
          <button id="quickSearchBtn" class="btn-icon btn-xs" title="Quick Search (Shift+Space)" style="opacity: 0.6;">
            <span class="mdi mdi-magnify" style="font-size: 14px;"></span>
          </button>
        </div>
        <div id="widgetPalette" class="widget-list"></div>
      </div>

      <div class="sidebar-section">
        <div id="currentLayoutIndicator"
          style="background: rgba(255,255,255,0.03); padding: 6px 10px; border-radius: 6px; margin-bottom: 6px; font-size: 10px;">
          <div style="color: var(--muted); margin-bottom: 4px; display: flex; justify-content: space-between;">
            <span>LAYOUT</span>
            <span id="sidebarStatus" style="font-size: 10px; opacity: 0.6;">Ready</span>
          </div>
          <strong id="currentLayoutName">Loading...</strong>
        </div>
        <div style="display: flex; gap: 4px;">
          <button id="saveLayoutBtn" class="btn btn-secondary" style="flex: 1;">Save Layout</button>
          <button id="importLayoutBtn" class="btn btn-secondary" style="flex: 1;">Import Layout</button>
        </div>
        <input type="file" id="loadLayoutBtn" accept=".json" style="display:none;" />
        <button id="manageLayoutsBtn" class="btn btn-secondary btn-full" style="margin-top: 4px;">üìÅ Layout
          Manager</button>
      </div>
    </aside>

    <div class="resizer" id="resizer-left"></div>

    <main class="main" role="main">
      <div id="canvasViewport" class="canvas-viewport">
        <div class="canvas-rulers">
          <div id="rulerTop" class="ruler ruler-h"></div>
          <div id="rulerLeft" class="ruler ruler-v"></div>
          <div class="ruler-corner"></div>
        </div>
        <div class="canvas-controls">
          <div class="canvas-info">
            <span id="currentPageName">Loading...</span>
            <span class="separator">/</span>
            <span id="zoomLevel">100%</span>
          </div>
          <div class="zoom-actions">
            <button id="gridToggleBtn" class="btn-icon" title="Toggle Grid (G)">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3h18v18H3zM3 9h18M3 15h18M9 3v18M15 3v18"></path>
              </svg>
            </button>
            <button id="debugGridToggleBtn" class="btn-icon" title="Toggle Debug Mode (D)">
              <span class="mdi mdi-bug-outline" style="font-size: 16px;"></span>
            </button>
            <button id="rulersToggleBtn" class="btn-icon" title="Toggle Rulers (R)" style="margin-right: 8px;">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path
                  d="M5 7h14c1.1 0 2 .9 2 2v6c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V9c0-1.1.9-2 2-2zm2 8v-3m4 3V9m4 6v-3">
                </path>
              </svg>
            </button>
            <button id="zoomOutBtn" class="btn-icon" title="Zoom Out">‚àí</button>
            <button id="zoomResetBtn" class="btn-icon" title="Reset View (Ctrl+0)">‚åÇ</button>
            <button id="zoomToFitAllBtn" class="btn-icon" title="Zoom to Fit All Pages">
              <span class="mdi mdi-view-grid-outline" style="font-size: 16px;"></span>
            </button>
            <button id="zoomInBtn" class="btn-icon" title="Zoom In">+</button>
          </div>
        </div>

        <div id="canvasContainer" class="canvas-container">
          <div id="canvas" class="canvas-stage">
            <!-- Artboards will be rendered here dynamically -->
          </div>
        </div>
      </div>

      <div class="resizer-h" id="resizer-bottom"></div>
      <div class="code-panel">
        <div class="code-panel-header">
          <div class="code-panel-title">
            <button id="toggleYamlBtn" class="btn-icon btn-xs code-toggle-btn" title="Toggle YAML Panel">
              <svg class="chevron" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor"
                stroke-width="3">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            ESPHome YAML
          </div>
          <div class="code-panel-actions">
            <button id="toggleHighlightBtn" class="btn btn-secondary btn-xs btn-icon" title="Toggle Syntax Highlighting"
              style="width: auto; padding: 0 6px; border-radius: 4px;">
              <span class="mdi mdi-palette-outline" style="font-size: 14px;"></span>
            </button>
            <button id="aiPromptBtn" class="btn btn-secondary btn-xs btn-icon" title="AI Assistant"
              style="width: auto; padding: 0 6px; border-radius: 4px;">
              <span class="mdi mdi-robot-outline" style="font-size: 14px;"></span>
            </button>
            <button id="copySnippetBtn" class="btn btn-secondary btn-xs" title="Copy full YAML output">
              <span class="mdi mdi-content-copy" style="font-size: 12px; margin-right: 4px;"></span>All
            </button>
            <button id="copyLambdaBtn" class="btn btn-secondary btn-xs" title="Copy display lambda only (C++ code)">
              <span class="mdi mdi-content-copy" style="font-size: 12px; margin-right: 4px;"></span>Œª
            </button>
            <button id="copyOEPLServiceBtn" class="btn btn-secondary btn-xs" style="display:none;"
              title="Copy full HA Service Call">
              <span class="mdi mdi-content-copy" style="font-size: 12px; margin-right: 4px;"></span>OEPL
            </button>
            <button id="copyODPServiceBtn" class="btn btn-secondary btn-xs" style="display:none;"
              title="Copy full HA Service Call">
              <span class="mdi mdi-content-copy" style="font-size: 12px; margin-right: 4px;"></span>ODP
            </button>
            <button id="fullscreenSnippetBtn" class="btn btn-secondary btn-xs btn-icon" title="Expand code panel"
              style="width: auto; padding: 0 6px; border-radius: 4px;">
              <span class="mdi mdi-fullscreen" style="font-size: 14px;"></span>
            </button>
            <button id="updateLayoutBtn" class="btn btn-secondary btn-xs btn-icon" title="Import YAML back to canvas"
              style="width: auto; padding: 0 6px; border-radius: 4px;">
              <span class="mdi mdi-import" style="font-size: 14px;"></span>
            </button>
          </div>
        </div>
        <div id="oeplNotice" class="oepl-notice hidden"
          style="background: rgba(255, 159, 67, 0.1); border-bottom: 1px solid rgba(255, 159, 67, 0.2); padding: 8px 12px; font-size: 10px; color: #ff9f43; display: flex; align-items: center; gap: 8px;">
          <span class="mdi mdi-alert-circle-outline" style="font-size: 14px;"></span>
          <div>
            <strong>OpenEpaperLink JSON (Beta)</strong> - Copy this to Home Assistant ‚Üí Developer Tools ‚Üí Services ‚Üí
            <code>open_epaper_link.drawcustom</code>
          </div>
        </div>
        <div id="odpNotice" class="odp-notice hidden"
          style="background: rgba(82, 199, 234, 0.1); border-bottom: 1px solid rgba(82, 199, 234, 0.2); padding: 8px 12px; font-size: 10px; color: var(--accent); display: flex; align-items: center; gap: 8px;">
          <span class="mdi mdi-informational" style="font-size: 14px;"></span>
          <div>
            <strong>OpenDisplay JSON (ODP)</strong> - Compatible with ODP v1 primitives.
          </div>
        </div>
        <div class="snippet-container">
          <pre id="highlightLayer" class="highlight-layer" aria-hidden="true"></pre>
          <textarea id="snippetBox" class="snippet-box" spellcheck="false"
            placeholder="# Click 'Generate' to see the ESPHome configuration..."></textarea>
        </div>
      </div>
    </main>

    <div class="resizer" id="resizer-right"></div>

    <aside class="right-panel" role="complementary" aria-label="Widget Properties">
      <!-- Hierarchy Panel -->
      <div class="sidebar-section" style="border-bottom: 1px solid var(--border-subtle);">
        <div class="sidebar-section-label"
          style="padding: 12px 16px 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;"
          id="hierarchyHeader">
          <div style="display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="2" width="18" height="18" rx="2"></rect>
              <line x1="7" y1="8" x2="17" y2="8"></line>
              <line x1="7" y1="12" x2="17" y2="12"></line>
              <line x1="7" y1="16" x2="17" y2="16"></line>
            </svg>
            <span>Hierarchy</span>
          </div>
          <svg class="chevron" viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor"
            stroke-width="3" style="transition: transform 0.2s; transform: rotate(0deg);">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>
        <div id="hierarchyPanel" class="hierarchy-content"
          style="max-height: 250px; overflow-y: auto; padding: 0 8px 8px;">
          <div id="hierarchyList" class="hierarchy-list"></div>
        </div>
      </div>

      <div class="sidebar-section-label"
        style="padding: 12px 16px 0; display: flex; justify-content: space-between; align-items: center;">
        <span>Properties</span>
        <label style="display:flex; align-items:center; gap:4px; font-size:10px; cursor:pointer;" title="Snap to grid">
          <input id="snapToggle" type="checkbox" checked style="width:12px; height:12px;" />
          <span>Snap</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; font-size:10px; cursor:pointer;"
          title="Lock position (Ctrl+L)">
          <input id="lockPositionToggle" type="checkbox" style="width:12px; height:12px;" />
          <span>Lock</span>
        </label>
      </div>
      <div id="propertiesPanel" class="properties-content">
        <div class="empty-state">
          Select a widget on the canvas to edit its properties.
        </div>
      </div>
    </aside>
  </div>

  <!-- Modals -->
  <!-- Fullscreen Modal -->
  <div id="snippetFullscreenModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div style="display: flex; align-items: center; gap: 12px;">
          ESPHome YAML (Fullscreen)
          <button id="toggleFullscreenHighlightBtn" class="btn btn-secondary btn-xs btn-icon"
            title="Toggle Syntax Highlighting" style="width: auto; padding: 0 6px; border-radius: 4px;">
            <span class="mdi mdi-palette-outline" style="font-size: 14px;"></span>
          </button>
        </div>
        <button id="snippetFullscreenClose" class="btn btn-secondary">Close</button>
      </div>
      <div class="modal-body">
        <div class="snippet-container" id="snippetFullscreenContainer" style="height: 100%;">
          <pre id="snippetFullscreenHighlight" class="highlight-layer" aria-hidden="true"></pre>
          <div id="snippetFullscreenContent" style="width: 100%; height: 100%;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importSnippetModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div>Import Layout from YAML</div>
        <button id="importSnippetCancel" class="btn btn-secondary">Cancel</button>
      </div>
      <div class="modal-body">
        <textarea id="importSnippetTextarea" class="prop-input" style="height:400px; font-family:monospace;"
          placeholder="# Paste ESPHome YAML here..."></textarea>
        <div id="importSnippetError" style="color:var(--danger); font-size:11px; margin-top:8px;"></div>
      </div>
      <div class="modal-actions">
        <button id="importSnippetConfirm" class="btn btn-secondary">Import</button>
      </div>
    </div>
  </div>

  <!-- Page Settings Modal -->
  <div id="pageSettingsModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div>Page Settings</div>
        <button id="pageSettingsClose" class="btn btn-secondary">Close</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="prop-label">Page Name</div>
          <input id="pageSettingsName" class="prop-input" type="text" />
        </div>
        <div class="field">
          <div class="prop-label">Refresh Mode</div>
          <select id="pageSettingsRefreshMode" class="prop-input">
            <option value="interval">Periodic Interval</option>
            <option value="daily">Daily at specific time</option>
          </select>
        </div>
        <div class="field" id="field-refresh-interval">
          <div class="prop-label">Interval (seconds)</div>
          <input id="pageSettingsRefresh" class="prop-input" type="number" min="0" placeholder="60" />
        </div>
        <div class="field" id="field-refresh-time" style="display:none;">
          <div class="prop-label">Wake-up Time (HH:MM)</div>
          <input id="pageSettingsRefreshTime" class="prop-input" type="time" />
        </div>
        <div class="field">
          <div class="prop-label">Visual Style</div>
          <select id="pageSettingsDarkMode" class="prop-input">
            <option value="inherit">Inherit Global</option>
            <option value="light">Always Light</option>
            <option value="dark">Always Dark</option>
          </select>
        </div>
        <div class="field">
          <div class="prop-label">Layout Mode (LVGL)</div>
          <select id="pageSettingsLayoutMode" class="prop-input">
            <option value="absolute">Absolute Positioning</option>
            <option value="grid">Grid Layout</option>
          </select>
          <div id="field-grid-size" style="display:none; margin-top:8px;">
            <div class="prop-label">Grid Size (RxC)</div>
            <input id="pageSettingsGridSize" class="prop-input" type="text" placeholder="4x4" pattern="[0-9]+x[0-9]+" />
            <div style="font-size:10px; color:var(--muted); margin-top:4px;">Format: rows√ócolumns, e.g. 2x3, 4x4</div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="pageSettingsSave" class="btn btn-secondary">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Device Settings Modal -->
  <div id="deviceSettingsModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div>Device Settings</div>
        <button id="deviceSettingsClose" class="btn btn-secondary">Close</button>
      </div>
      <div class="modal-body">
        <div class="settings-grid">
          <!-- PRIMARY SETTINGS (Top 2x2 Grid) -->
          <div class="primary-settings-grid">
            <div class="field">
              <div class="prop-label">Friendly Name</div>
              <input id="deviceName" class="prop-input" type="text" placeholder="My E-Ink Device" />
            </div>

            <div class="field" id="renderingModeField">
              <div class="prop-label">Rendering Mode</div>
              <select id="renderingMode" class="prop-input">
                <option value="direct">Direct (Display Lambda)</option>
                <option value="lvgl">LVGL (Recommended for LCD)</option>
                <option value="oepl">OpenEpaperLink JSON (Drawing Protocol)</option>
                <option value="opendisplay">OpenDisplay JSON (ODP)</option>
              </select>
            </div>

            <div class="field">
              <div class="prop-label">Screen Orientation</div>
              <select id="deviceOrientation" class="prop-input">
                <option value="landscape">Landscape</option>
                <option value="portrait">Portrait</option>
              </select>
            </div>
          </div>

          <!-- SECONDARY SETTINGS (Left Column) -->
          <div class="settings-column">
            <!-- Dynamic Hardware Profile Section (ESPHome Only) -->
            <div class="field" id="deviceModelField"
              style="border-bottom: 1px solid var(--border-subtle); padding-bottom: 12px; margin-bottom: 8px;">
              <div class="prop-label" style="display:flex; justify-content:space-between; align-items:center;">
                <span>Hardware Profile</span>
                <div style="display: flex; gap: 4px;">
                  <button id="reloadHardwareBtn" class="btn btn-secondary btn-xs"
                    style="font-size: 10px; padding: 2px 6px;" title="Reload hardware profiles from server">‚ü≥
                    Reload</button>
                  <button id="importHardwareBtn" class="btn btn-secondary btn-xs"
                    style="font-size: 10px; padding: 2px 6px;">Import Recipe</button>
                </div>
              </div>
              <select id="deviceModel" class="prop-input">
                <option value="custom">Custom Profile...</option>
              </select>
              <input type="file" id="hardwareFileInput" accept=".yaml" style="display:none;" />
            </div>

            <!-- OpenEpaperLink Settings -->
            <div id="oeplSettingsSection" style="display:none;">
              <div style="font-size: 11px; font-weight: bold; color: var(--accent); margin-bottom: 8px;">
                OpenEpaperLink Configuration</div>
              <div class="field">
                <div class="prop-label">OEPL Tag Entity ID</div>
                <input id="oeplEntityId" class="prop-input" type="text"
                  placeholder="open_epaper_link.0000000000000000" />
              </div>
              <div class="field">
                <div class="prop-label">Dithering Algorithm</div>
                <select id="oeplDither" class="prop-input">
                  <option value="0">None (Faster)</option>
                  <option value="1">Ordered</option>
                  <option value="2" selected>Burkes (Recommended)</option>
                  <option value="3">Atkinson</option>
                  <option value="4">Floyd-Steinberg</option>
                  <option value="5">Jarvis-Judice-Ninke</option>
                  <option value="6">Stucki</option>
                  <option value="7">Sierra</option>
                </select>
              </div>
            </div>

            <!-- OpenDisplay Settings -->
            <div id="odpSettingsSection" style="display:none;">
              <div style="font-size: 11px; font-weight: bold; color: var(--accent); margin-bottom: 8px;">
                OpenDisplay Configuration (ODP)</div>
              <div class="field">
                <div class="prop-label">ODP Display Entity ID</div>
                <input id="opendisplayEntityId" class="prop-input" type="text"
                  placeholder="opendisplay.0000000000000000" />
              </div>
              <div class="field">
                <div class="prop-label">Dithering Algorithm</div>
                <select id="opendisplayDither" class="prop-input">
                  <option value="0">None (Faster)</option>
                  <option value="1">Ordered</option>
                  <option value="2" selected>Burkes (Recommended)</option>
                  <option value="3">Atkinson</option>
                  <option value="4">Floyd-Steinberg</option>
                  <option value="5">Jarvis-Judice-Ninke</option>
                  <option value="6">Stucki</option>
                  <option value="7">Sierra</option>
                </select>
              </div>
              <div class="field">
                <div class="prop-label">Update Interval (TTL)</div>
                <input id="opendisplayTtl" class="prop-input" type="number" min="0" placeholder="60" />
                <div style="font-size:9px; color:var(--muted); margin-top:4px;">In seconds. 0 = never expires.</div>
              </div>
            </div>

            <!-- Custom Hardware Section -->
            <div id="customHardwareSection"
              style="display:none; border:1px solid var(--accent); border-radius:8px; padding:12px; background: rgba(82, 199, 234, 0.03);">
              <div
                style="font-size:11px; font-weight:bold; color:var(--accent); margin-bottom:12px; display:flex; align-items:center; gap:8px;">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                  <path
                    d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z">
                  </path>
                </svg>
                Custom Hardware Pinout
              </div>

              <div class="hardware-group" style="border:none; margin:0; padding:0;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                  <div class="field">
                    <div class="prop-label" style="font-size:10px;">Chip Type</div>
                    <select id="customChip" class="prop-input-sm">
                      <option value="esp32-s3">ESP32-S3</option>
                      <option value="esp32">ESP32</option>
                      <option value="esp32-c3">ESP32-C3</option>
                      <option value="esp32-c6">ESP32-C6</option>
                      <option value="esp8266">ESP8266 (Experimental)</option>
                    </select>
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:10px;">Tech</div>
                    <select id="customTech" class="prop-input-sm">
                      <option value="lcd">LCD / OLED</option>
                      <option value="epaper">E-Paper</option>
                    </select>
                  </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                  <div class="field">
                    <div class="prop-label" style="font-size:10px;">Resolution Preset</div>
                    <select id="customResPreset" class="prop-input-sm">
                      <option value="custom">Manual...</option>
                      <!-- LCD / OLED -->
                      <optgroup label="LCD / OLED">
                        <option value="128x64">128x64 (0.96")</option>
                        <option value="128x128">128x128 (1.44")</option>
                        <option value="240x240">240x240 (1.3/1.54")</option>
                        <option value="320x240">320x240 (2.4/2.8")</option>
                        <option value="320x480">320x480 (3.5")</option>
                        <option value="480x320">480x320 (3.5" alt)</option>
                        <option value="480x480">480x480 (Round/Square)</option>
                        <option value="800x480">800x480 (4-7")</option>
                        <option value="1024x600">1024x600 (7-10")</option>
                      </optgroup>
                      <!-- E-Paper -->
                      <optgroup label="E-Paper">
                        <option value="250x122">2.13" (250x122)</option>
                        <option value="296x128">2.9" (296x128)</option>
                        <option value="400x300">4.2" (400x300)</option>
                        <option value="600x448">5.65" (600x448 7-Color)</option>
                        <option value="640x384">5.83" (640x384)</option>
                        <option value="800x480">7.5" (800x480)</option>
                        <option value="880x528">7.5" HD (880x528)</option>
                      </optgroup>
                    </select>
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:10px;">Shape</div>
                    <select id="customShape" class="prop-input-sm">
                      <option value="rect">Rectangle</option>
                      <option value="round">Round</option>
                    </select>
                  </div>
                </div>
                <div class="field">
                  <div class="prop-label" style="font-size:10px;">Manual Resolution</div>
                  <input id="customRes" class="prop-input-sm" type="text" placeholder="800x480" value="800x480" />
                </div>
                <div style="display:flex; gap:16px; margin-top:8px;">
                  <label style="display:flex; align-items:center; gap:6px; font-size:10px; cursor:pointer;">
                    <input id="customPsram" type="checkbox" checked />
                    <span>PSRAM</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:10px; cursor:pointer;">
                    <input id="customAntiburn" type="checkbox" />
                    <span>Anti-burn (LCD)</span>
                  </label>
                </div>
              </div>

              <!-- GPIO Pin Datalists (allows dropdown + free text) -->
              <datalist id="gpio-pins-esp32">
                <option value="">‚Äî None ‚Äî</option>
                <option value="GPIO0">GPIO0 (boot)</option>
                <option value="GPIO1">GPIO1 (TX)</option>
                <option value="GPIO2">GPIO2</option>
                <option value="GPIO3">GPIO3 (RX)</option>
                <option value="GPIO4">GPIO4</option>
                <option value="GPIO5">GPIO5</option>
                <option value="GPIO12">GPIO12</option>
                <option value="GPIO13">GPIO13</option>
                <option value="GPIO14">GPIO14</option>
                <option value="GPIO15">GPIO15</option>
                <option value="GPIO16">GPIO16</option>
                <option value="GPIO17">GPIO17</option>
                <option value="GPIO18">GPIO18 (VSPI CLK)</option>
                <option value="GPIO19">GPIO19 (VSPI MISO)</option>
                <option value="GPIO21">GPIO21 (I2C SDA)</option>
                <option value="GPIO22">GPIO22 (I2C SCL)</option>
                <option value="GPIO23">GPIO23 (VSPI MOSI)</option>
                <option value="GPIO25">GPIO25</option>
                <option value="GPIO26">GPIO26</option>
                <option value="GPIO27">GPIO27</option>
                <option value="GPIO32">GPIO32</option>
                <option value="GPIO33">GPIO33</option>
                <option value="GPIO34">GPIO34 (input only)</option>
                <option value="GPIO35">GPIO35 (input only)</option>
                <option value="GPIO36">GPIO36 (input only)</option>
                <option value="GPIO39">GPIO39 (input only)</option>
              </datalist>
              <datalist id="gpio-pins-esp32s3">
                <option value="">‚Äî None ‚Äî</option>
                <option value="GPIO0">GPIO0</option>
                <option value="GPIO1">GPIO1</option>
                <option value="GPIO2">GPIO2</option>
                <option value="GPIO3">GPIO3</option>
                <option value="GPIO4">GPIO4</option>
                <option value="GPIO5">GPIO5</option>
                <option value="GPIO6">GPIO6</option>
                <option value="GPIO7">GPIO7</option>
                <option value="GPIO8">GPIO8</option>
                <option value="GPIO9">GPIO9</option>
                <option value="GPIO10">GPIO10</option>
                <option value="GPIO11">GPIO11</option>
                <option value="GPIO12">GPIO12</option>
                <option value="GPIO13">GPIO13</option>
                <option value="GPIO14">GPIO14</option>
                <option value="GPIO15">GPIO15</option>
                <option value="GPIO16">GPIO16</option>
                <option value="GPIO17">GPIO17</option>
                <option value="GPIO18">GPIO18</option>
                <option value="GPIO19">GPIO19</option>
                <option value="GPIO20">GPIO20</option>
                <option value="GPIO21">GPIO21</option>
                <option value="GPIO38">GPIO38</option>
                <option value="GPIO39">GPIO39</option>
                <option value="GPIO40">GPIO40</option>
                <option value="GPIO41">GPIO41</option>
                <option value="GPIO42">GPIO42</option>
                <option value="GPIO45">GPIO45</option>
                <option value="GPIO46">GPIO46</option>
                <option value="GPIO47">GPIO47</option>
                <option value="GPIO48">GPIO48</option>
              </datalist>
              <datalist id="gpio-pins-esp8266">
                <option value="">‚Äî None ‚Äî</option>
                <option value="GPIO16">GPIO16 (D0 - Wake)</option>
                <option value="GPIO5">GPIO5 (D1 - SCL)</option>
                <option value="GPIO4">GPIO4 (D2 - SDA)</option>
                <option value="GPIO0">GPIO0 (D3 - Flash)</option>
                <option value="GPIO2">GPIO2 (D4 - LED)</option>
                <option value="GPIO14">GPIO14 (D5 - SCK)</option>
                <option value="GPIO12">GPIO12 (D6 - MISO)</option>
                <option value="GPIO13">GPIO13 (D7 - MOSI)</option>
                <option value="GPIO15">GPIO15 (D8 - CS)</option>
                <option value="GPIO3">GPIO3 (RX)</option>
                <option value="GPIO1">GPIO1 (TX)</option>
                <option value="GPIO10">GPIO10 (SD3 - Flash)</option>
                <option value="GPIO9">GPIO9 (SD2 - Flash)</option>
              </datalist>

              <div class="hardware-group" style="margin-top:12px;">
                <div class="prop-label" style="font-size:10px; margin-bottom:4px;">Display (SPI)</div>
                <select id="customDisplayDriver" class="prop-input-sm" style="margin-bottom:8px;">
                  <option value="st7789v">ST7789 (LCD)</option>
                  <option value="ili9341">ILI9341 (LCD)</option>
                  <option value="ili9342">ILI9342 (LCD)</option>
                  <option value="ili9488">ILI9488 (LCD)</option>
                  <option value="waveshare_epaper">Waveshare E-Paper</option>
                  <option value="epaper_spi">Generic SPI E-Paper</option>
                  <option value="custom">Other (Custom YAML)</option>
                </select>

                <div id="customDisplayModelField" class="field" style="display:none; margin-bottom:8px;">
                  <div class="prop-label" style="font-size:10px;">Display Model</div>
                  <input id="customDisplayModel" class="prop-input-sm" type="text" placeholder="e.g. 7.50inV2"
                    list="waveshare_models" />
                  <div style="font-size:9px; color:var(--muted);">Required for Waveshare E-Paper</div>

                  <datalist id="waveshare_models">
                    <option value="1.54in">1.54"</option>
                    <option value="1.54inv2">1.54" V2</option>
                    <option value="2.13in">2.13"</option>
                    <option value="2.13inv2">2.13" V2</option>
                    <option value="2.13inv3">2.13" V3</option>
                    <option value="2.13in-ttgo">2.13" TTGO</option>
                    <option value="2.66in">2.66"</option>
                    <option value="2.70in">2.70"</option>
                    <option value="2.90in">2.90"</option>
                    <option value="2.90inv2">2.90" V2</option>
                    <option value="2.90in-dke">2.90" DKE</option>
                    <option value="3.52in">3.52"</option>
                    <option value="3.70in">3.70"</option>
                    <option value="4.20in">4.20"</option>
                    <option value="4.20inv2">4.20" V2</option>
                    <option value="5.65in">5.65" (Color)</option>
                    <option value="5.83in">5.83"</option>
                    <option value="5.83inv2">5.83" V2</option>
                    <option value="7.50in">7.50"</option>
                    <option value="7.50inv2">7.50" V2</option>
                    <option value="7.50inv2p">7.50" V2 (Partial Refresh)</option>
                    <option value="7.50hd">7.50" HD</option>
                  </datalist>
                </div>

                <div id="spiPinsGrid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px;">
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">CS</div>
                    <input id="pin_cs" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO10" />
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">DC</div>
                    <input id="pin_dc" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO11" />
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">RST <span style="opacity:0.5">(opt)</span></div>
                    <div style="display:flex; gap:2px;">
                      <input id="pin_rst" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                        placeholder="(optional)" style="flex:1;" />
                      <button type="button" class="clear-pin-btn" data-target="pin_rst" title="Clear"
                        style="padding:0 4px; font-size:10px; background:#eee; border:1px solid #ccc; border-radius:3px; cursor:pointer;">√ó</button>
                    </div>
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">BUSY <span style="opacity:0.5">(opt)</span></div>
                    <div style="display:flex; gap:2px;">
                      <input id="pin_busy" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                        placeholder="(optional)" style="flex:1;" />
                      <button type="button" class="clear-pin-btn" data-target="pin_busy" title="Clear"
                        style="padding:0 4px; font-size:10px; background:#eee; border:1px solid #ccc; border-radius:3px; cursor:pointer;">√ó</button>
                    </div>
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">CLK</div>
                    <input id="pin_clk" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO18" />
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">MOSI</div>
                    <input id="pin_mosi" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO23" />
                  </div>
                </div>
              </div>

              <!-- Backlight & I2C Pins -->
              <div class="hardware-group" style="margin-top:12px;">
                <div class="prop-label" style="font-size:10px; margin-bottom:4px;">Backlight & I2C</div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px;">
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">Backlight</div>
                    <input id="pin_backlight" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO45" />
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">I2C SDA</div>
                    <input id="pin_sda" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO21" />
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">I2C SCL</div>
                    <input id="pin_scl" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO22" />
                  </div>
                </div>
              </div>

              <!-- Touch Controller -->
              <div class="hardware-group" style="margin-top:12px;">
                <div class="prop-label" style="font-size:10px; margin-bottom:4px;">Touch Controller</div>
                <select id="customTouchTech" class="prop-input-sm" style="margin-bottom:8px;">
                  <option value="none">None</option>
                  <option value="gt911">GT911 (I2C)</option>
                  <option value="cst816">CST816 (I2C)</option>
                  <option value="ft5x06">FT5x06 (I2C)</option>
                  <option value="xpt2046">XPT2046 (SPI)</option>
                </select>
                <div id="touchPinsGrid" style="display:none; grid-template-columns:1fr 1fr; gap:6px;">
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">Touch INT</div>
                    <input id="pin_touch_int" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO4" />
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">Touch RST</div>
                    <input id="pin_touch_rst" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO5" />
                  </div>
                </div>
              </div>

              <div class="field" style="margin-top:12px; border-top:1px solid var(--border-subtle); padding-top:8px;">
                <div class="prop-label" style="font-size:10px;">Recipe Name</div>
                <input id="customProfileName" class="prop-input-sm" type="text" placeholder="e.g. My Custom S3" />
              </div>

              <button id="saveCustomProfileBtn" class="btn btn-primary btn-full" type="button" style="margin-top:12px;">
                üöÄ Save Profile
              </button>
            </div>

            <!-- Protocol Hardware Section (OEPL / ODP) -->
            <div id="protocolHardwareSection"
              style="display:none; border:1px solid var(--accent); border-radius:8px; padding:12px; background: rgba(82, 199, 234, 0.03);">
              <div
                style="font-size:11px; font-weight:bold; color:var(--accent); margin-bottom:12px; display:flex; align-items:center; gap:8px;">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                  <line x1="8" y1="21" x2="16" y2="21"></line>
                  <line x1="12" y1="17" x2="12" y2="21"></line>
                </svg>
                Protocol Hardware Specs
              </div>

              <div class="field">
                <div class="prop-label">Resolution Preset</div>
                <select id="protocolResPreset" class="prop-input">
                  <option value="custom">Manual...</option>
                  <option value="296x128">2.9" (296x128)</option>
                  <option value="400x300">4.2" (400x300)</option>
                  <option value="800x480">7.5" (800x480)</option>
                  <option value="640x384">5.83" (640x384)</option>
                  <option value="250x122">2.13" (250x122)</option>
                </select>
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <div class="field">
                  <div class="prop-label">Width</div>
                  <input id="protocolWidth" class="prop-input" type="number" value="400" />
                </div>
                <div class="field">
                  <div class="prop-label">Height</div>
                  <input id="protocolHeight" class="prop-input" type="number" value="300" />
                </div>
              </div>

              <div class="field">
                <div class="prop-label">Color Mode</div>
                <select id="protocolColorMode" class="prop-input">
                  <option value="bw">Monochrome (B/W)</option>
                  <option value="grayscale">Grayscale</option>
                  <option value="color_3">3-Color (BWR / BWY)</option>
                  <option value="full_color">Full Color</option>
                </select>
              </div>
            </div>

            <!-- Global Preferences -->
            <div class="field" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle);">
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input id="deviceDarkMode" type="checkbox" />
                <span style="font-size:var(--fs-xs); font-weight:600;">Dark mode (Canvas Preview)</span>
              </label>
            </div>
            <div class="field" id="deviceExtendedLatinGlyphsField">
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input id="deviceExtendedLatinGlyphs" type="checkbox" />
                <span style="font-size:var(--fs-xs); font-weight:600;">Extended Latin Glyphs</span>
              </label>
            </div>
            <div class="field" id="deviceInvertedColorsField">
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input id="deviceInvertedColors" type="checkbox" />
                <span style="font-size:var(--fs-xs); font-weight:600;">Inverted Colors (E-Paper)</span>
              </label>
            </div>
          </div>
        </div>

        <div id="powerStrategySection"
          style="border-top:1px solid var(--border-subtle); margin-top:16px; padding-top:16px;">
          <div class="prop-label">Power & Refresh Strategy</div>

          <div id="global-refresh-row"
            style="margin-top: 12px; margin-bottom: 16px; background: rgba(82, 199, 234, 0.05); padding: 10px; border-radius: 6px; border-left: 3px solid var(--accent);">
            <div class="prop-label" style="font-size: 11px; margin-bottom: 4px;">Global Refresh Interval</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <input type="number" id="setting-refresh-interval" class="prop-input" placeholder="600"
                style="width: 80px;" min="5">
              <span style="font-size: 11px; opacity: 0.7;">seconds</span>
            </div>
            <div style="font-size: 10px; opacity: 0.6; margin-top: 4px;">Default time between updates. Can be overridden
              on individual pages.</div>
          </div>

          <!-- E-Paper Specific Strategies -->
          <div id="strategy-epaper-group" style="display:flex; flex-direction:column; gap:12px; margin-top:8px;">
            <div
              style="font-size:10px; font-weight:bold; text-transform:uppercase; color:var(--muted); margin-bottom:4px;">
              E-Paper Options</div>

            <!-- Standard -->
            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" id="mode-standard" name="powerStrategy" value="standard"
                  onchange="togglePowerSettings()">
                Full Power (Always On)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px;">Device stays connected to Wi-Fi. Fast
                response, but high battery drain.</div>
            </div>

            <!-- Night Mode -->
            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" id="setting-sleep-enabled" name="powerStrategy" value="night"
                  onchange="togglePowerSettings()">
                Eco (Scheduled Night Sleep)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px; margin-bottom:4px;">Stops refreshing during
                these hours to save energy.</div>
            </div>

            <!-- Daily Refresh -->
            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" id="setting-daily-refresh-enabled" name="powerStrategy" value="daily"
                  onchange="togglePowerSettings()">
                Daily Scheduled Refresh
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px; margin-bottom:4px;">Wakes up once per day at a
                specific time.</div>
            </div>

            <!-- Manual Only -->
            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" id="setting-manual-refresh" name="powerStrategy" value="manual"
                  onchange="togglePowerSettings()">
                Manual Refresh Only
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px;">Never updates automatically. Only refreshes
                when a button is pressed.</div>
            </div>

            <!-- Deep Sleep -->
            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" id="setting-deep-sleep-enabled" name="powerStrategy" value="deepsleep"
                  onchange="togglePowerSettings()">
                Ultra Eco (Deep Sleep)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px; margin-bottom:4px;">Shuts down completely
                between updates. Best for battery life.</div>
            </div>
          </div>

          <div id="strategy-lcd-group" style="display:none; flex-direction:column; gap:12px; margin-top:8px;">
            <div
              style="font-size:10px; font-weight:bold; text-transform:uppercase; color:var(--muted); margin-bottom:4px;">
              LCD / OLED Options</div>

            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" name="lcdEcoStrategy" value="always_on" onchange="togglePowerSettings()">
                Always On (Full Brightness)
              </label>
            </div>

            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" name="lcdEcoStrategy" value="backlight_off" onchange="togglePowerSettings()">
                Eco (Backlight Off Schedule)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px;">Turns off backlight during sleep hours
                (recommended for LCD).</div>
            </div>

            <div id="lcd-strategy-dim-row">
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" name="lcdEcoStrategy" value="dim_after_timeout" onchange="togglePowerSettings()">
                Eco (Dim after timeout)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px;">Turns off backlight and pauses LVGL after
                period of inactivity. Resume on touch.</div>
            </div>

            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" name="lcdEcoStrategy" value="halt_updates" onchange="togglePowerSettings()">
                Eco (Halt Loop)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px;">Stops update cycle but leaves screen powered.
              </div>
            </div>

            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" name="lcdEcoStrategy" value="deep_sleep" onchange="togglePowerSettings()">
                Ultra Eco (Deep Sleep)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px;">Power down between updates.</div>
            </div>
          </div>

          <!-- Dim Timeout (Used by LCD Dim after timeout) -->
          <div id="dim-timeout-row"
            style="display:none; align-items:center; gap:8px; margin-left:24px; margin-top:8px; background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 4px;">
            <span style="font-size: 11px; opacity: 0.7;">Dim after</span>
            <input type="number" id="setting-dim-timeout" class="prop-input" placeholder="10" style="width:80px;"
              min="1" value="10">
            <span style="font-size: 11px; opacity: 0.7;">seconds</span>
          </div>

          <!-- Common Sleep Times (Used by both) -->
          <div id="sleep-times-row"
            style="display:none; flex-direction:column; gap:8px; margin-left:24px; margin-top:8px; background: rgba(0,0,0,0.03); padding: 8px; border-radius: 4px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size: 11px; opacity: 0.7;">Sleep from</span>
              <select id="setting-sleep-start" class="prop-input" style="width:70px;">
                <option value="0">00:00</option>
                <option value="1">01:00</option>
                <option value="2">02:00</option>
                <option value="3">03:00</option>
                <option value="4">04:00</option>
                <option value="5">05:00</option>
                <option value="6">06:00</option>
                <option value="7">07:00</option>
                <option value="8">08:00</option>
                <option value="9">09:00</option>
                <option value="10">10:00</option>
                <option value="11">11:00</option>
                <option value="12">12:00</option>
                <option value="13">13:00</option>
                <option value="14">14:00</option>
                <option value="15">15:00</option>
                <option value="16">16:00</option>
                <option value="17">17:00</option>
                <option value="18">18:00</option>
                <option value="19">19:00</option>
                <option value="20">20:00</option>
                <option value="21">21:00</option>
                <option value="22">22:00</option>
                <option value="23">23:00</option>
              </select>
              <span style="font-size: 11px; opacity: 0.7;">to</span>
              <select id="setting-sleep-end" class="prop-input" style="width:70px;">
                <option value="0">00:00</option>
                <option value="1">01:00</option>
                <option value="2">02:00</option>
                <option value="3">03:00</option>
                <option value="4">04:00</option>
                <option value="5">05:00</option>
                <option value="6">06:00</option>
                <option value="7">07:00</option>
                <option value="8">08:00</option>
                <option value="9">09:00</option>
                <option value="10">10:00</option>
                <option value="11">11:00</option>
                <option value="12">12:00</option>
                <option value="13">13:00</option>
                <option value="14">14:00</option>
                <option value="15">15:00</option>
                <option value="16">16:00</option>
                <option value="17">17:00</option>
                <option value="18">18:00</option>
                <option value="19">19:00</option>
                <option value="20">20:00</option>
                <option value="21">21:00</option>
                <option value="22">22:00</option>
                <option value="23">23:00</option>
              </select>
            </div>
          </div>

          <div id="daily-refresh-row"
            style="display:none; align-items:center; gap:8px; margin-left:24px; margin-top:8px; background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 4px;">
            <span style="font-size: 11px; opacity: 0.7;">Refresh at</span>
            <input type="time" id="setting-daily-refresh-time" class="prop-input" value="08:00" style="width:100px;">
          </div>

          <div id="deep-sleep-interval-row"
            style="display:none; align-items:center; gap:8px; margin-left:24px; margin-top:8px; background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 4px;">
            <span style="font-size: 11px; opacity: 0.7;">Update every</span>
            <input type="number" id="setting-deep-sleep-interval" class="prop-input" placeholder="Seconds"
              style="width:80px;">
            <span style="font-size: 11px; opacity: 0.7;">sec</span>
          </div>

          <!-- Silent Hours -->
          <div style="border-top:1px solid var(--border-subtle); margin-top:8px; padding-top:12px;">
            <div
              style="display:flex; align-items:center; gap:8px; font-size:var(--fs-sm); font-weight: 500; color: var(--accent);">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path
                  d="M17.22 17.22L2 2M12 2v2M4.93 4.93l1.41 1.41M2 12h2M6.34 17.66l-1.41 1.41M12 22v-2m7.07-2.93l-1.41-1.41M22 12h-2m-3.34-5.66l1.41-1.41M12 7a5 5 0 015 5 4.94 4.94 0 01-.46 2.06M12 17a5 5 0 01-5-5 4.94 4.94 0 01.46-2.06">
                </path>
              </svg>
              Silent Hours (No Refresh Window)
            </div>
            <div style="font-size:10px; opacity:0.6; margin-left:24px; margin-bottom:8px;">Prevent all display
              updates
              during this time window. Used to avoid night-time ghosts/noise.</div>
            <div
              style="display:flex; align-items:center; gap:8px; margin-left:24px; background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 4px;">
              <span style="font-size: 11px; opacity: 0.7;">Disable updates from</span>
              <select id="setting-no-refresh-start" class="prop-input" style="width:70px;">
                <option value="">None</option>
                <option value="0">00:00</option>
                <option value="1">01:00</option>
                <option value="2">02:00</option>
                <option value="3">03:00</option>
                <option value="4">04:00</option>
                <option value="5">05:00</option>
                <option value="6">06:00</option>
                <option value="7">07:00</option>
                <option value="8">08:00</option>
                <option value="9">09:00</option>
                <option value="10">10:00</option>
                <option value="11">11:00</option>
                <option value="12">12:00</option>
                <option value="13">13:00</option>
                <option value="14">14:00</option>
                <option value="15">15:00</option>
                <option value="16">16:00</option>
                <option value="17">17:00</option>
                <option value="18">18:00</option>
                <option value="19">19:00</option>
                <option value="20">20:00</option>
                <option value="21">21:00</option>
                <option value="22">22:00</option>
                <option value="23">23:00</option>
              </select>
              <span style="font-size: 11px; opacity: 0.7;">to</span>
              <select id="setting-no-refresh-end" class="prop-input" style="width:70px;">
                <option value="">None</option>
                <option value="0">00:00</option>
                <option value="1">01:00</option>
                <option value="2">02:00</option>
                <option value="3">03:00</option>
                <option value="4">04:00</option>
                <option value="5">05:00</option>
                <option value="6">06:00</option>
                <option value="7">07:00</option>
                <option value="8">08:00</option>
                <option value="9">09:00</option>
                <option value="10">10:00</option>
                <option value="11">11:00</option>
                <option value="12">12:00</option>
                <option value="13">13:00</option>
                <option value="14">14:00</option>
                <option value="15">15:00</option>
                <option value="16">16:00</option>
                <option value="17">17:00</option>
                <option value="18">18:00</option>
                <option value="19">19:00</option>
                <option value="20">20:00</option>
                <option value="21">21:00</option>
                <option value="22">22:00</option>
                <option value="23">23:00</option>
              </select>
            </div>
          </div>

          <!-- Page Auto-Cycling -->
          <div style="border-top:1px solid var(--border-subtle); margin-top:8px; padding-top:12px;">
            <div
              style="display:flex; align-items:center; gap:8px; font-size:var(--fs-sm); font-weight: 600; color: var(--accent);">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
              Page Auto-Cycling
            </div>
            <div style="font-size:10px; opacity:0.6; margin-left:24px; margin-bottom:8px;">Automatically cycle
              through
              pages on a timer.</div>
            <div style="margin-left: 24px; display: flex; flex-direction: column; gap: 8px;">
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input id="setting-auto-cycle" type="checkbox" />
                <span style="font-size:var(--fs-xs); font-weight:500;">Enable Automatic Page Cycling</span>
              </label>
              <div id="field-auto-cycle-interval"
                style="display:none; align-items:center; gap:8px; background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 4px;">
                <span style="font-size: 11px; opacity: 0.7;">Cycle every</span>
                <input type="number" id="setting-auto-cycle-interval" class="prop-input" min="5" placeholder="30"
                  style="width:80px;">
                <span style="font-size: 11px; opacity: 0.7;">seconds</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="deviceSettingsSave" class="btn btn-secondary">Apply Settings</button>
      </div>
    </div>
  </div>

  <!-- Save Profile Modal -->
  <div id="saveProfileModal" class="modal-backdrop hidden" style="z-index: 2000;">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <div>Save Hardware Profile</div>
        <button id="saveProfileClose" class="btn btn-secondary">Cancel</button>
      </div>
      <div class="modal-body">
        <div style="font-size: 11px; opacity: 0.7; margin-bottom: 12px;">
          Give your custom hardware configuration a unique name. It will be saved as a reusable recipe.
        </div>
        <div class="field">
          <div class="prop-label">Profile Name</div>
          <input id="saveProfileName" class="prop-input" type="text" placeholder="e.g. Living Room Display" />
        </div>
      </div>
      <div class="modal-actions">
        <button id="saveProfileConfirm" class="btn btn-secondary"
          style="background: var(--accent); color: white; border: none;">Save Profile</button>
      </div>
    </div>
  </div>

  <!-- Editor Settings Modal -->
  <div id="editorSettingsModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div>Editor Preferences</div>
        <button id="editorSettingsClose" class="btn btn-secondary">Close</button>
      </div>
      <div class="modal-body">
        <!-- CATEGORY: VIEW & THEME -->
        <div class="settings-category collapsible expanded" data-category="view">
          <div class="settings-category-header">
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="mdi mdi-eye-outline"></span>
              <span>View & Theme</span>
            </div>
            <span class="mdi mdi-chevron-down category-chevron"></span>
          </div>
          <div class="settings-category-content">
            <div class="field">
              <label style="display:flex; align-items:center; gap:8px; cursor: pointer;">
                <input type="checkbox" id="editorShowGrid" checked> <span>Show Grid</span>
              </label>
              <label style="display:flex; align-items:center; gap:8px; cursor: pointer;">
                <input type="checkbox" id="editorSnapToGrid" checked> <span>Enable Snapping</span>
              </label>
              <div style="margin-top:12px;">
                <div class="prop-label">Grid Opacity</div>
                <input type="range" id="editorGridOpacity" min="0" max="100" step="1" value="8" style="width:100%;">
              </div>
            </div>
            <div class="field">
              <div class="prop-label">Interface Theme</div>
              <label style="display:flex; align-items:center; gap:8px; cursor: pointer;">
                <input type="checkbox" id="editorLightMode"> <span>Use Light Mode interface</span>
              </label>
            </div>
          </div>
        </div>

        <!-- CATEGORY: FONT SETTINGS -->
        <div class="settings-category collapsible" data-category="fonts">
          <div class="settings-category-header">
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="mdi mdi-format-font"></span>
              <span>Font Settings</span>
            </div>
            <span class="mdi mdi-chevron-down category-chevron"></span>
          </div>
          <div class="settings-category-content">
            <div class="field">
              <div class="prop-label">Global Glyphsets</div>
              <div style="font-size:10px; opacity:0.6; margin-bottom:8px;">Select glyphsets to include language specific
                characters (like √•, √∂, √§) in the generated YAML for all fonts.</div>
              <div id="editorGlyphsets"
                style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Latin_Kernel"> <span>Latin Kernel <small
                      style="opacity:0.6">(Basic A-Z, 0-9)</small></span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Latin_Core"> <span>Latin Core <small
                      style="opacity:0.6">(√•, √∂, √§, √©, √ü...)</small></span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Arabic_Core"> <span>Arabic Core <small
                      style="opacity:0.6">(ÿß, ÿ®, ÿ™...)</small></span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Cyrillic_Core"> <span>Cyrillic <small
                      style="opacity:0.6">(–ê, –ë, –í...)</small></span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Greek_Core"> <span>Greek <small
                      style="opacity:0.6">(Œ±, Œ≤, Œ≥...)</small></span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Latin_African"> <span>Latin African</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Latin_PriAfrican"> <span>Latin
                    PriAfrican</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Latin_Vietnamese"> <span>Vietnamese <small
                      style="opacity:0.6">(√†, √°, ·∫£...)</small></span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- CATEGORY: CONNECTIVITY -->
        <div class="settings-category collapsible" data-category="ha">
          <div class="settings-category-header">
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="mdi mdi-home-assistant"></span>
              <span>Home Assistant</span>
            </div>
            <span class="mdi mdi-chevron-down category-chevron"></span>
          </div>
          <div class="settings-category-content">
            <div class="field">
              <div class="prop-label">Resources</div>
              <button id="editorRefreshEntities" class="btn btn-secondary btn-xs">Refresh Entity List</button>
              <span id="editorEntityCount" style="font-size:var(--fs-xs); opacity:0.6; margin-left:8px;"></span>
            </div>
            <div class="field">
              <div class="prop-label">Connection Settings</div>
              <div style="font-size:10px; opacity:0.6; margin-bottom:8px;">Configure this if you are using the
                GitHub-hosted version or an external URL.</div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <div id="haCorsTip"
                  style="background: rgba(82, 199, 234, 0.1); border-left: 3px solid var(--accent); padding: 10px; border-radius: 4px; font-size: 10px; line-height: 1.4;">
                  <strong>üí° Connection Tip:</strong><br>
                  If requests are blocked, you may need to add <code
                    id="haOriginPlaceholder">http://localhost:8000</code> to <code>cors_allowed_origins</code> and
                  <strong>restart HA</strong>.
                </div>
                <div>
                  <div class="prop-label" style="font-size: 10px;">Base URL</div>
                  <input type="text" id="haManualUrl" class="prop-input"
                    placeholder="https://your-ha.duckdns.org:8123" />
                </div>
                <div>
                  <div class="prop-label" style="font-size: 10px;">Long-Lived Access Token</div>
                  <input type="password" id="haLlatToken" class="prop-input" placeholder="Paste your token here..." />
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button id="editorTestHaBtn" class="btn btn-secondary btn-xs" style="flex:1;">Test Connection</button>
                  <div id="haTestResult" style="font-size:10px; line-height: 1.2;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CATEGORY: AI ASSISTANT -->
        <div class="settings-category collapsible" data-category="ai">
          <div class="settings-category-header">
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="mdi mdi-robot-outline"></span>
              <span>AI Integration (LLM)</span>
            </div>
            <span class="mdi mdi-chevron-down category-chevron"></span>
          </div>
          <div class="settings-category-content">
            <div style="font-size:10px; opacity:0.6; margin-bottom:8px;">Configure Gemini, OpenAI or OpenRouter to use
              natural language prompts.</div>
            <div class="field" style="display:flex; flex-direction:column; gap:8px;">
              <div>
                <div class="prop-label" style="font-size: 10px;">Provider</div>
                <select id="aiProvider" class="prop-input">
                  <option value="gemini">Google Gemini</option>
                  <option value="openai">OpenAI</option>
                  <option value="openrouter">OpenRouter</option>
                </select>
              </div>
              <div id="aiKeyGeminiRow">
                <div class="prop-label" style="font-size: 10px;">Gemini API Key</div>
                <input type="password" id="aiApiKeyGemini" class="prop-input" placeholder="Paste Gemini key..." />
              </div>
              <div id="aiKeyOpenaiRow" style="display:none;">
                <div class="prop-label" style="font-size: 10px;">OpenAI API Key</div>
                <input type="password" id="aiApiKeyOpenai" class="prop-input" placeholder="Paste OpenAI key..." />
              </div>
              <div id="aiKeyOpenrouterRow" style="display:none;">
                <div class="prop-label" style="font-size: 10px;">OpenRouter API Key</div>
                <input type="password" id="aiApiKeyOpenrouter" class="prop-input"
                  placeholder="Paste OpenRouter key..." />
              </div>
              <div>
                <div class="prop-label" style="font-size: 10px;">Model Filter (e.g. "free", "flash", "gpt-4")</div>
                <div style="display:flex; gap:4px; align-items: center;">
                  <input type="text" id="aiModelFilter" class="prop-input" placeholder="Filter models..."
                    style="flex:1;" />
                  <button id="aiRefreshModelsBtn" class="btn btn-secondary btn-xs">Test & Load Models</button>
                  <div id="aiTestResult" style="font-size:10px; line-height: 1.2;"></div>
                </div>
              </div>
              <div>
                <div class="prop-label" style="font-size: 10px;">Selected Model</div>
                <select id="aiModelSelect" class="prop-input"></select>
              </div>
            </div>
          </div>
        </div>

        <!-- CATEGORY: SHORTCUTS -->
        <div class="settings-category collapsible" data-category="shortcuts">
          <div class="settings-category-header">
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="mdi mdi-keyboard-outline"></span>
              <span>Keyboard Shortcuts</span>
            </div>
            <span class="mdi mdi-chevron-down category-chevron"></span>
          </div>
          <div class="settings-category-content">
            <div class="shortcuts-grid">
              <div class="shortcut-item"><span class="shortcut-label">Undo</span><span
                  class="shortcut-key"><kbd>Ctrl+Z</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Redo</span><span
                  class="shortcut-key"><kbd>Ctrl+Y</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Copy</span><span
                  class="shortcut-key"><kbd>Ctrl+C</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Paste</span><span
                  class="shortcut-key"><kbd>Ctrl+V</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Delete</span><span
                  class="shortcut-key"><kbd>DEL</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Lock/Unlock</span><span
                  class="shortcut-key"><kbd>Ctrl+L</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Search</span><span
                  class="shortcut-key"><kbd>Shift+Space</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Debug Mode</span><span
                  class="shortcut-key"><kbd>D</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Design Grid</span><span
                  class="shortcut-key"><kbd>G</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Rulers</span><span
                  class="shortcut-key"><kbd>R</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Zoom Reset</span><span
                  class="shortcut-key"><kbd>Ctrl+R</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Snap Off</span><span
                  class="shortcut-key"><kbd>ALT</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Distances</span><span
                  class="shortcut-key"><kbd>CTRL Drag</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Group</span><span
                  class="shortcut-key"><kbd>Ctrl+G</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Ungroup</span><span
                  class="shortcut-key"><kbd>Ctrl+Shift+G</kbd></span></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="editorSettingsDone" class="btn btn-secondary">Done</button>
      </div>
    </div>
  </div>

  <!-- AI Prompt Modal -->
  <div id="aiPromptModal" class="modal-backdrop hidden">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <div>AI Design Assistant</div>
        <button id="aiPromptClose" class="btn btn-secondary">Close</button>
      </div>
      <div class="modal-body">
        <div id="aiConfigWarning"
          style="background: rgba(82, 199, 234, 0.1); border-left: 3px solid var(--accent); padding: 10px; border-radius: 4px; font-size: 11px; margin-bottom: 12px; line-height: 1.4;">
          <strong>üí° Configuration Required:</strong><br>
          An API provider and key must be configured in <strong>Editor Settings</strong> before using the AI
          Assistant.
          <button
            onclick="window.openEditorSettingsModal('ai'); document.getElementById('aiPromptModal').classList.add('hidden');"
            class="btn btn-secondary btn-xs" style="margin-top:8px; display:block;">‚öô Open Editor
            Settings</button>
        </div>
        <div style="font-size: 11px; color: var(--muted); margin-bottom: 12px;">
          Describe what you want to change. Example: "Move the selected widget 50px right" or "Make a nice weather
          layout with 4 days forecast".
        </div>
        <textarea id="aiPromptInput" class="prop-input"
          style="height: 120px; font-size: 14px; line-height: 1.5; padding: 12px;"
          placeholder="I want to..."></textarea>

        <div id="aiPromptStatus" style="margin-top: 12px; font-size: 11px; min-height: 1.2em;"></div>

        <div id="aiPreviewDiff"
          style="display:none; margin-top:16px; border: 1px solid var(--border-subtle); border-radius: 8px; overflow: hidden;">
          <div
            style="background: rgba(255,255,255,0.03); padding: 8px 12px; font-size: 10px; font-weight: 600; border-bottom: 1px solid var(--border-subtle);">
            PREVIEW CHANGES</div>
          <div id="aiDiffContent"
            style="padding: 12px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; background: var(--bg-input);">
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="aiPromptSubmit" class="btn btn-primary"
          style="background: var(--accent); color: white; border: none;">Generate</button>
        <button id="aiPromptApply" class="btn btn-success" style="display:none;">Apply</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Polyfill for crypto.randomUUID for non-secure contexts (HTTP/Ingress)
    if (!window.crypto.randomUUID) {
      window.crypto.randomUUID = function () {
        return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
          (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
      };
    }

    // Protocol Warning for file:// access
    if (window.location.protocol === 'file:') {
      document.addEventListener('DOMContentLoaded', () => {
        const warning = document.createElement('div');
        warning.style.cssText = `
          position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
          background: #ff9f43; color: #333; padding: 12px 36px 12px 24px;
          border-radius: 8px; z-index: 10000; font-weight: bold;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center;
          line-height: 1.4; border: 1px solid rgba(0,0,0,0.1);
          font-family: sans-serif; font-size: 14px;
        `;
        warning.innerHTML = `
          <span>‚ö†Ô∏è Running from local file. Full functionality is not guaranteed.<br>
          <small>For the best experience, install via HACS or use a local server.</small></span>
          <button onclick="this.parentElement.remove()" style="
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: none; border: none; font-size: 18px; cursor: pointer; color: #333;
            padding: 4px; line-height: 1;
          ">&times;</button>
        `;
        document.body.appendChild(warning);
        console.warn("[CORS] Running on file:// protocol. Some features may be limited.");
      });
    }

    function togglePowerSettings() {
      const isSleep = document.getElementById('setting-sleep-enabled').checked;
      const isDaily = document.getElementById('setting-daily-refresh-enabled').checked;
      const isDeepSleep = document.getElementById('setting-deep-sleep-enabled').checked;
      document.getElementById('sleep-times-row').style.display = isSleep ? 'flex' : 'none';
      document.getElementById('daily-refresh-row').style.display = isDaily ? 'flex' : 'none';
      document.getElementById('deep-sleep-interval-row').style.display = isDeepSleep ? 'block' : 'none';
    }
    function toggleWidgetCategory(c) {
      const cat = document.querySelector(`.widget-category[data-category="${c}"]`);
      if (cat) {
        cat.classList.toggle('expanded');
        const icon = cat.querySelector('.category-icon');
        if (icon) {
          icon.textContent = cat.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
  <script src="js/lib/js-yaml.min.js"></script>

  <script type="module" src="js/utils/helpers.js"></script>
  <script type="module" src="js/utils/env.js"></script>
  <script type="module" src="js/utils/dom.js"></script>
  <script type="module" src="js/utils/device.js"></script>
  <script type="module" src="js/utils/graph_helpers.js"></script>
  <script type="module" src="js/core/constants.js"></script>
  <script type="module" src="js/core/utils.js"></script>
  <script type="module" src="js/core/constants_icons.js"></script>
  <script type="module" src="js/core/events.js"></script>
  <script type="module" src="js/core/state.js"></script>
  <script type="module" src="js/core/plugin_registry.js"></script>
  <!-- Feature Plugins (Dynamic ESM Loading) -->
  <script type="module" src="js/core/widget_factory.js"></script>
  <script type="module" src="js/core/sidebar.js"></script>
  <script type="module" src="js/core/canvas.js"></script>
  <script type="module" src="js/core/properties.js"></script>
  <script type="module" src="js/core/keyboard.js"></script>
  <script type="module" src="js/core/layout_constants.js"></script>
  <script type="module" src="js/io/file_ops.js"></script>
  <script type="module" src="js/io/ha_api.js"></script>
  <script type="module" src="js/io/yaml_import.js"></script>
  <script type="module" src="js/io/hardware_import.js"></script>

  <script type="module" src="js/io/adapters/base_adapter.js"></script>
  <script type="module" src="js/io/adapters/esphome_adapter.js"></script>
  <script type="module" src="js/io/adapters/oepl_adapter.js"></script>
  <script type="module" src="js/io/adapters/opendisplay_adapter.js"></script>
  <script type="module" src="js/io/devices.js"></script>
  <script type="module" src="js/io/hardware_generators.js"></script>
  <script type="module" src="js/io/hardware_generator.js"></script>
  <script type="module" src="js/io/yaml_export.js"></script>
  <script type="module" src="js/io/yaml_export_lvgl.js"></script>
  <script type="module" src="js/ui/device_settings.js"></script>
  <script type="module" src="js/ui/editor_settings.js"></script>
  <script type="module" src="js/ui/llm_prompt.js"></script>
  <script type="module" src="js/ui/page_settings.js"></script>
  <script type="module" src="js/ui/entity_picker.js"></script>
  <script type="module" src="js/ui/layout_manager.js"></script>
  <script type="module" src="js/ui/splitters.js"></script>
  <script type="module" src="js/ui/modal_wiring.js"></script>
  <script type="module" src="js/ui/icon_picker.js"></script>
  <script type="module" src="js/ui/quick_search.js"></script>
  <script type="module" src="js/ui/radial_menu.js"></script>

  <!-- Global App Entry -->
  <script type="module" src="js/main.js"></script>
</body>

</html>