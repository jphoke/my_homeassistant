esphome:
  name: sussex-epaper-color
  friendly_name: Sussex House ePaper Color
  on_boot:
    priority: 600
    then:
      - output.turn_on: bsp_battery_enable
      - delay: 200ms
      - component.update: epaper_display
      - script.execute: manage_run_and_sleep



esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_key
  services:
    - service: play_tone
      variables:
        melody: string
      then:
        - rtttl.play: !lambda 'return melody;'
    - service: beep_short
      then:
        - rtttl.play: "beep:d=32,o=5,b=200:16e6"
    - service: beep_ok
      then:
        - rtttl.play: "ok:d=16,o=5,b=200:e6"
    - service: beep_error
      then:
        - rtttl.play: "error:d=16,o=5,b=200:c6"

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid2
  password: !secret wifi_password

  ap:
    ssid: "Sussex-EPaper-Color"
    password: !secret ap_password

captive_portal:

psram:
  mode: octal
  speed: 80MHz

time:
  - platform: homeassistant
    id: ha_time

i2c:
  sda: GPIO19
  scl: GPIO20
  scan: true

spi:
  clk_pin: GPIO7
  mosi_pin: GPIO9

output:
  - platform: gpio
    pin: GPIO21
    id: bsp_battery_enable

  - platform: ledc
    pin: GPIO45
    id: buzzer_output

rtttl:
  id: reterminal_buzzer
  output: buzzer_output

globals:
  - id: display_page
    type: int
    restore_value: true
    initial_value: '0'

  - id: page_refresh_default_s
    type: int
    restore_value: no
    initial_value: '1800'  # 30 minutes

  - id: page_refresh_current_s
    type: int
    restore_value: no
    initial_value: '1800'

sensor:
  # Hardware sensors
  - platform: sht4x
    temperature:
      name: "reTerminal Onboard Temperature"
      id: onboard_temperature
      accuracy_decimals: 2
      filters:
        - round: 2
    humidity:
      name: "reTerminal Onboard Humidity"
      id: onboard_humidity
      accuracy_decimals: 2
      filters:
        - round: 2
    address: 0x44
    update_interval: 60s

  - platform: adc
    pin: GPIO1
    name: "Battery Voltage"
    id: battery_voltage
    update_interval: 60s
    attenuation: 12db
    accuracy_decimals: 2
    filters:
      - multiply: 2.0
      - round: 2

  - platform: template
    name: "Battery Level"
    id: battery_level
    lambda: 'return id(battery_voltage).state;'
    unit_of_measurement: "%"
    device_class: battery
    update_interval: 60s
    accuracy_decimals: 0
    filters:
      - calibrate_linear:
          - 3.27 -> 0.0
          - 4.15 -> 100.0
      - clamp:
          min_value: 0
          max_value: 100
      - round: 0

  # Home Assistant sensors - Indoor
  - platform: homeassistant
    id: dining_temp
    entity_id: sensor.dining_room_current_temperature
    internal: true
    accuracy_decimals: 1

  - platform: homeassistant
    id: dining_humidity
    entity_id: sensor.dining_room_current_humidity
    internal: true
    accuracy_decimals: 0

  - platform: homeassistant
    id: office_temp
    entity_id: sensor.office_multisensor_bme280_temperature
    internal: true
    accuracy_decimals: 1

  - platform: homeassistant
    id: office_humidity
    entity_id: sensor.office_multisensor_bme280_humidity
    internal: true
    accuracy_decimals: 0

  - platform: homeassistant
    id: basement_temp
    entity_id: sensor.basement_air_sensor_sen55_temperature
    internal: true
    accuracy_decimals: 1

  - platform: homeassistant
    id: basement_humidity
    entity_id: sensor.basement_air_sensor_sen55_humidity
    internal: true
    accuracy_decimals: 0

  # AQI
  - platform: homeassistant
    id: aqi_value
    entity_id: sensor.airnow_air_quality_index
    internal: true
    accuracy_decimals: 0
# Weather attributes
  - platform: homeassistant
    id: weather_temp
    entity_id: sensor.weather_temperature
    internal: true
    accuracy_decimals: 1

  - platform: homeassistant
    id: weather_feels_like
    entity_id: sensor.weather_apparent_temperature
    internal: true
    accuracy_decimals: 1

  - platform: homeassistant
    id: weather_humidity
    entity_id: sensor.weather_humidity
    internal: true
    accuracy_decimals: 0

  - platform: homeassistant
    id: weather_wind_speed
    entity_id: sensor.weather_wind_speed
    internal: true
    accuracy_decimals: 1

  - platform: homeassistant
    id: weather_wind_bearing
    entity_id: sensor.weather_wind_bearing
    internal: true
    accuracy_decimals: 0

  - platform: homeassistant
    id: weather_pressure
    entity_id: sensor.weather_pressure
    internal: true
    accuracy_decimals: 2

  # Forecast Day 1
  - platform: homeassistant
    id: forecast_day1_high
    entity_id: sensor.forecast_day_1_high
    internal: true
    accuracy_decimals: 0

  - platform: homeassistant
    id: forecast_day1_low
    entity_id: sensor.forecast_day_1_low
    internal: true
    accuracy_decimals: 0

  # Forecast Day 2
  - platform: homeassistant
    id: forecast_day2_high
    entity_id: sensor.forecast_day_2_high
    internal: true
    accuracy_decimals: 0

  - platform: homeassistant
    id: forecast_day2_low
    entity_id: sensor.forecast_day_2_low
    internal: true
    accuracy_decimals: 0

  # Forecast Day 3
  - platform: homeassistant
    id: forecast_day3_high
    entity_id: sensor.forecast_day_3_high
    internal: true
    accuracy_decimals: 0

  - platform: homeassistant
    id: forecast_day3_low
    entity_id: sensor.forecast_day_3_low
    internal: true
    accuracy_decimals: 0

  # Forecast Day 4
  - platform: homeassistant
    id: forecast_day4_high
    entity_id: sensor.forecast_day_4_high
    internal: true
    accuracy_decimals: 0

  - platform: homeassistant
    id: forecast_day4_low
    entity_id: sensor.forecast_day_4_low
    internal: true
    accuracy_decimals: 0

  # Forecast Day 5
  - platform: homeassistant
    id: forecast_day5_high
    entity_id: sensor.forecast_day_5_high
    internal: true
    accuracy_decimals: 0

  - platform: homeassistant
    id: forecast_day5_low
    entity_id: sensor.forecast_day_5_low
    internal: true
    accuracy_decimals: 0    

text_sensor:
  # Weather entity
  - platform: homeassistant
    id: weather_pirateweather
    entity_id: weather.pirateweather
    internal: true
# Forecast day names and conditions
  - platform: homeassistant
    id: forecast_day1_name
    entity_id: sensor.forecast_day_1_name
    internal: true

  - platform: homeassistant
    id: forecast_day1_condition
    entity_id: sensor.forecast_day_1_condition
    internal: true

  - platform: homeassistant
    id: forecast_day2_name
    entity_id: sensor.forecast_day_2_name
    internal: true

  - platform: homeassistant
    id: forecast_day2_condition
    entity_id: sensor.forecast_day_2_condition
    internal: true

  - platform: homeassistant
    id: forecast_day3_name
    entity_id: sensor.forecast_day_3_name
    internal: true

  - platform: homeassistant
    id: forecast_day3_condition
    entity_id: sensor.forecast_day_3_condition
    internal: true

  - platform: homeassistant
    id: forecast_day4_name
    entity_id: sensor.forecast_day_4_name
    internal: true

  - platform: homeassistant
    id: forecast_day4_condition
    entity_id: sensor.forecast_day_4_condition
    internal: true

  - platform: homeassistant
    id: forecast_day5_name
    entity_id: sensor.forecast_day_5_name
    internal: true

  - platform: homeassistant
    id: forecast_day5_condition
    entity_id: sensor.forecast_day_5_condition
    internal: true
font:
  # Gotham Rounded fonts
  - file: fonts/Gotham Rounded Bold.otf
    id: font_header_bold
    size: 28

  - file: fonts/Gotham Rounded Medium.otf
    id: font_body_medium
    size: 22

  - file: fonts/Gotham Rounded Medium.otf
    id: font_body_small
    size: 18

  - file: fonts/Gotham Rounded Medium.otf
    id: font_tiny
    size: 14

  # Material Design Icons
  - file: fonts/materialdesignicons-webfont.ttf
    id: font_mdi_large
    size: 64
    glyphs: [
      "\U000F0590", # weather-cloudy
      "\U000F0591", # weather-fog
      "\U000F0592", # weather-hail
      "\U000F0593", # weather-lightning
      "\U000F0594", # weather-night (clear-night)
      "\U000F0595", # weather-partly-cloudy
      "\U000F0596", # weather-pouring
      "\U000F0597", # weather-rainy
      "\U000F0598", # weather-snowy
      "\U000F0599", # weather-sunny
      "\U000F059D", # weather-windy
      "\U000F067E", # weather-lightning-rainy
      "\U000F067F", # weather-snowy-rainy
      "\U000F0F2F", # weather-cloudy-alert
      "\U000F0F31", # weather-night-partly-cloudy
      "\U000F0F32", # weather-partly-lightning
      "\U000F0F33", # weather-partly-rainy
      "\U000F0024"  # alert-circle (exceptional)
    ]

  - file: fonts/materialdesignicons-webfont.ttf
    id: font_mdi_medium
    size: 32
    glyphs: [
      "\U000F0590", "\U000F0591", "\U000F0592", "\U000F0593", 
      "\U000F0594", "\U000F0595", "\U000F0596", "\U000F0597",
      "\U000F0598", "\U000F0599", "\U000F059D", "\U000F067E",
      "\U000F067F", "\U000F0F2F", "\U000F0F31", "\U000F0F32",
      "\U000F0F33", "\U000F0024"
    ]

  - file: fonts/materialdesignicons-webfont.ttf
    id: font_mdi_small
    size: 24
    glyphs: [
      "\U000F050F", # thermometer (temp icon)
      "\U000F058E", # water-percent (humidity icon)
      "\U000F0F4C", # air-filter (AQI icon)
      "\U000F059C", # weather-windy
      "\U000F029A"  # gauge (pressure icon)
    ]

button:
  - platform: template
    name: "Next Page"
    id: next_page
    on_press:
      - lambda: |-
          id(display_page) = (id(display_page) + 1) % 3;
      - component.update: epaper_display

  - platform: template
    name: "Previous Page"
    id: prev_page
    on_press:
      - lambda: |-
          id(display_page) = (id(display_page) - 1 + 3) % 3;
      - component.update: epaper_display

  - platform: template
    name: "Refresh Display"
    id: refresh_display
    on_press:
      - component.update: epaper_display

  - platform: template
    name: "Go to Page 1"
    id: goto_page_0
    on_press:
      - lambda: 'id(display_page) = 0;'
      - component.update: epaper_display

  - platform: template
    name: "Go to Page 2"
    id: goto_page_1
    on_press:
      - lambda: 'id(display_page) = 1;'
      - component.update: epaper_display

  - platform: template
    name: "Go to Page 3"
    id: goto_page_2
    on_press:
      - lambda: 'id(display_page) = 2;'
      - component.update: epaper_display

script:
  - id: manage_run_and_sleep
    mode: restart
    then:
      - wait_until:
          condition:
            lambda: 'return id(ha_time).now().is_valid();'
          timeout: 120s
      
      - lambda: |-
          int interval = id(page_refresh_default_s);
          id(page_refresh_current_s) = interval;
          ESP_LOGI("refresh", "Next refresh in %d seconds", interval);
      
      - component.update: epaper_display
      - delay: !lambda 'return id(page_refresh_current_s) * 1000;'
      - script.execute: manage_run_and_sleep

display:
  - platform: epaper_spi
    id: epaper_display
    model: 7.3in-spectra-e6
    cs_pin: GPIO10
    dc_pin: GPIO11
    reset_pin:
      number: GPIO12
      inverted: false
    busy_pin:
      number: GPIO13
      inverted: true
    update_interval: never
    lambda: |-
      ESP_LOGD("display", "Lambda executing, page=%d", id(display_page));
      // Spectra E6 panel supports 6 colors (white/black/red/yellow/green/blue)
      const Color COLOR_BLACK(0, 0, 0);
      const Color COLOR_WHITE(255, 255, 255);
      const Color COLOR_RED(255, 0, 0);
      const Color COLOR_YELLOW(255, 255, 0);
      const Color COLOR_BLUE(0, 0, 255);
      const Color COLOR_GREEN(67, 138, 28);
      
      // Clear display
      it.fill(COLOR_WHITE);

      if (id(display_page) == 0) {
        // ==================== HEADER ====================
        // "Sussex House" centered at top
        it.print(400, 20, id(font_header_bold), COLOR_BLACK, TextAlign::TOP_CENTER, "Sussex House");
        
        // Date below header
        it.strftime(400, 55, id(font_body_medium), COLOR_BLACK, TextAlign::TOP_CENTER, "%a, %b %d", id(ha_time).now());

        // Horizontal line under header
        it.line(20, 95, 780, 95, COLOR_BLACK);

        // ==================== LEFT COLUMN: OUTDOOR ====================
        int left_x = 20;
        int left_y = 110;

        // Section title
        it.print(left_x, left_y, id(font_body_medium), COLOR_BLACK, "Outdoor Conditions");
        left_y += 35;

        // Weather icon and condition
        std::string condition = id(weather_pirateweather).state;
        const char* weather_icon = "\U000F0599"; // default sunny
        
        if (condition == "clear-night") weather_icon = "\U000F0594";
        else if (condition == "cloudy") weather_icon = "\U000F0590";
        else if (condition == "fog") weather_icon = "\U000F0591";
        else if (condition == "hail") weather_icon = "\U000F0592";
        else if (condition == "lightning") weather_icon = "\U000F0593";
        else if (condition == "lightning-rainy") weather_icon = "\U000F067E";
        else if (condition == "partlycloudy") weather_icon = "\U000F0595";
        else if (condition == "pouring") weather_icon = "\U000F0596";
        else if (condition == "rainy") weather_icon = "\U000F0597";
        else if (condition == "snowy") weather_icon = "\U000F0598";
        else if (condition == "snowy-rainy") weather_icon = "\U000F067F";
        else if (condition == "sunny") weather_icon = "\U000F0599";
        else if (condition == "windy") weather_icon = "\U000F059D";
        else if (condition == "exceptional") weather_icon = "\U000F0024";

        it.printf(left_x, left_y, id(font_mdi_large), COLOR_BLACK, "%s", weather_icon);
        
        // Condition text next to icon
        std::string condition_text = condition;
        if (!condition_text.empty()) {
          condition_text[0] = toupper(condition_text[0]);
        }
        it.printf(left_x + 80, left_y + 20, id(font_body_medium), COLOR_BLACK, "%s", condition_text.c_str());
        
        left_y += 75;

        // Temperature and feels like
        if (id(weather_temp).has_state() && id(weather_feels_like).has_state()) {
          it.printf(left_x, left_y, id(font_body_small), COLOR_BLACK, 
                   "%.0f°F (Feels %.0f°F)", id(weather_temp).state, id(weather_feels_like).state);
        }
        left_y += 25;

        // Humidity
        if (id(weather_humidity).has_state()) {
          it.printf(left_x, left_y, id(font_body_small), COLOR_BLACK, 
                   "Humidity: %.0f%%", id(weather_humidity).state);
        }
        left_y += 25;

        // Wind speed and direction
        if (id(weather_wind_speed).has_state() && id(weather_wind_bearing).has_state()) {
          int bearing = (int)id(weather_wind_bearing).state;
          const char* direction = "N";
          
          if (bearing >= 349 || bearing < 11) direction = "N";
          else if (bearing >= 11 && bearing < 34) direction = "NNE";
          else if (bearing >= 34 && bearing < 56) direction = "NE";
          else if (bearing >= 56 && bearing < 79) direction = "ENE";
          else if (bearing >= 79 && bearing < 101) direction = "E";
          else if (bearing >= 101 && bearing < 124) direction = "ESE";
          else if (bearing >= 124 && bearing < 146) direction = "SE";
          else if (bearing >= 146 && bearing < 169) direction = "SSE";
          else if (bearing >= 169 && bearing < 191) direction = "S";
          else if (bearing >= 191 && bearing < 214) direction = "SSW";
          else if (bearing >= 214 && bearing < 236) direction = "SW";
          else if (bearing >= 236 && bearing < 259) direction = "WSW";
          else if (bearing >= 259 && bearing < 281) direction = "W";
          else if (bearing >= 281 && bearing < 304) direction = "WNW";
          else if (bearing >= 304 && bearing < 326) direction = "NW";
          else if (bearing >= 326 && bearing < 349) direction = "NNW";
          
          it.printf(left_x, left_y, id(font_body_small), COLOR_BLACK, 
                   "Wind: %.0f mph %s", id(weather_wind_speed).state, direction);
        }
        left_y += 25;

        // Pressure
        if (id(weather_pressure).has_state()) {
          it.printf(left_x, left_y, id(font_body_small), COLOR_BLACK, 
                   "Pressure: %.2f inHg", id(weather_pressure).state);
        }
        left_y += 35;

        // AQI with color coding
        if (id(aqi_value).has_state()) {
          float aqi = id(aqi_value).state;
          Color aqi_color = COLOR_GREEN;
          const char* aqi_category = "Good";

          if (aqi >= 201) {
            aqi_color = COLOR_RED;
            aqi_category = "Very Unhealthy";
          } else if (aqi >= 151) {
            aqi_color = COLOR_RED;
            aqi_category = "Unhealthy";
          } else if (aqi >= 101) {
            aqi_color = COLOR_RED;   // No orange on Spectra; use red for Sensitive
            aqi_category = "Sensitive";
          } else if (aqi >= 51) {
            aqi_color = COLOR_YELLOW;
            aqi_category = "Moderate";
          }
          
          it.printf(left_x, left_y, id(font_mdi_small), aqi_color, "\U000F0F4C");
          it.printf(left_x + 35, left_y, id(font_body_small), COLOR_BLACK, "AQI: %.0f (%s)", aqi, aqi_category);
        }

        // ==================== RIGHT COLUMN: INDOOR ====================
        int right_x = 500;
        int right_y = 110;

        it.print(right_x, right_y, id(font_body_medium), COLOR_BLACK, "Indoor Conditions");
        right_y += 35;

        // Dining Room
        if (id(dining_temp).has_state() && id(dining_humidity).has_state()) {
          it.print(right_x, right_y, id(font_body_small), COLOR_BLACK, "Dining Room");
          right_y += 25;
          it.printf(right_x + 20, right_y, id(font_mdi_small), COLOR_BLACK, "\U000F050F");
          it.printf(right_x + 50, right_y, id(font_body_small), COLOR_BLACK, "%.1f°F", id(dining_temp).state);
          it.printf(right_x + 140, right_y, id(font_mdi_small), COLOR_BLACK, "\U000F058E");
          it.printf(right_x + 170, right_y, id(font_body_small), COLOR_BLACK, "%.0f%%", id(dining_humidity).state);
          right_y += 35;
        }

        // Office
        if (id(office_temp).has_state() && id(office_humidity).has_state()) {
          it.print(right_x, right_y, id(font_body_small), COLOR_BLACK, "Office");
          right_y += 25;
          it.printf(right_x + 20, right_y, id(font_mdi_small), COLOR_BLACK, "\U000F050F");
          it.printf(right_x + 50, right_y, id(font_body_small), COLOR_BLACK, "%.1f°F", id(office_temp).state);
          it.printf(right_x + 140, right_y, id(font_mdi_small), COLOR_BLACK, "\U000F058E");
          it.printf(right_x + 170, right_y, id(font_body_small), COLOR_BLACK, "%.0f%%", id(office_humidity).state);
          right_y += 35;
        }

        // Basement
        if (id(basement_temp).has_state() && id(basement_humidity).has_state()) {
          it.print(right_x, right_y, id(font_body_small), COLOR_BLACK, "Basement");
          right_y += 25;
          it.printf(right_x + 20, right_y, id(font_mdi_small), COLOR_BLACK, "\U000F050F");
          it.printf(right_x + 50, right_y, id(font_body_small), COLOR_BLACK, "%.1f°F", id(basement_temp).state);
          it.printf(right_x + 140, right_y, id(font_mdi_small), COLOR_BLACK, "\U000F058E");
          it.printf(right_x + 170, right_y, id(font_body_small), COLOR_BLACK, "%.0f%%", id(basement_humidity).state);
        }

        // ==================== BOTTOM: 5-DAY FORECAST ====================
        // Horizontal line above forecast
        it.line(20, 360, 780, 360, COLOR_BLACK);
        
        it.print(400, 370, id(font_body_medium), COLOR_BLACK, TextAlign::TOP_CENTER, "5-Day Forecast");
        
        int forecast_y = 405;
        int forecast_spacing = 156; // 780 pixels / 5 days ≈ 156 per day
        int x1 = 30;  // Define x1 at the start
        
        // Helper function to get weather icon for condition
        auto get_forecast_icon = [](const std::string& cond) -> const char* {
          if (cond == "clear-night") return "\U000F0594";
          else if (cond == "cloudy") return "\U000F0590";
          else if (cond == "fog") return "\U000F0591";
          else if (cond == "hail") return "\U000F0592";
          else if (cond == "lightning") return "\U000F0593";
          else if (cond == "lightning-rainy") return "\U000F067E";
          else if (cond == "partlycloudy") return "\U000F0595";
          else if (cond == "pouring") return "\U000F0596";
          else if (cond == "rainy") return "\U000F0597";
          else if (cond == "snowy") return "\U000F0598";
          else if (cond == "snowy-rainy") return "\U000F067F";
          else if (cond == "sunny") return "\U000F0599";
          else if (cond == "windy") return "\U000F059D";
          return "\U000F0599"; // default sunny
        };
        
        // Day 1
        if (id(forecast_day1_name).has_state() && id(forecast_day1_high).has_state() && id(forecast_day1_low).has_state()) {
          it.printf(x1, forecast_y, id(font_body_small), COLOR_BLACK, TextAlign::TOP_LEFT, 
                   "%s", id(forecast_day1_name).state.c_str());
          it.printf(x1 + 15, forecast_y + 25, id(font_mdi_medium), COLOR_BLACK, 
                   "%s", get_forecast_icon(id(forecast_day1_condition).state));
          
          float high1 = id(forecast_day1_high).state;
          float low1 = id(forecast_day1_low).state;
          Color high_color1 = (high1 > 80) ? COLOR_RED : COLOR_BLACK;
          Color low_color1 = (low1 < 32) ? COLOR_BLUE : COLOR_BLACK;
          
          it.printf(x1 + 65, forecast_y + 30, id(font_body_small), high_color1, "%.0f°", high1);
          it.printf(x1 + 65, forecast_y + 55, id(font_tiny), low_color1, "%.0f°", low1);
        }
        
        // Day 2
        int x2 = x1 + forecast_spacing;
        if (id(forecast_day2_name).has_state() && id(forecast_day2_high).has_state() && id(forecast_day2_low).has_state()) {
          it.printf(x2, forecast_y, id(font_body_small), COLOR_BLACK, TextAlign::TOP_LEFT, 
                   "%s", id(forecast_day2_name).state.c_str());
          it.printf(x2 + 15, forecast_y + 25, id(font_mdi_medium), COLOR_BLACK, 
                   "%s", get_forecast_icon(id(forecast_day2_condition).state));
          
          float high2 = id(forecast_day2_high).state;
          float low2 = id(forecast_day2_low).state;
          Color high_color2 = (high2 > 80) ? COLOR_RED : COLOR_BLACK;
          Color low_color2 = (low2 < 32) ? COLOR_BLUE : COLOR_BLACK;
          
          it.printf(x2 + 65, forecast_y + 30, id(font_body_small), high_color2, "%.0f°", high2);
          it.printf(x2 + 65, forecast_y + 55, id(font_tiny), low_color2, "%.0f°", low2);
        }
        
        // Day 3
        int x3 = x2 + forecast_spacing;
        if (id(forecast_day3_name).has_state() && id(forecast_day3_high).has_state() && id(forecast_day3_low).has_state()) {
          it.printf(x3, forecast_y, id(font_body_small), COLOR_BLACK, TextAlign::TOP_LEFT, 
                   "%s", id(forecast_day3_name).state.c_str());
          it.printf(x3 + 15, forecast_y + 25, id(font_mdi_medium), COLOR_BLACK, 
                   "%s", get_forecast_icon(id(forecast_day3_condition).state));
          
          float high3 = id(forecast_day3_high).state;
          float low3 = id(forecast_day3_low).state;
          Color high_color3 = (high3 > 80) ? COLOR_RED : COLOR_BLACK;
          Color low_color3 = (low3 < 32) ? COLOR_BLUE : COLOR_BLACK;
          
          it.printf(x3 + 65, forecast_y + 30, id(font_body_small), high_color3, "%.0f°", high3);
          it.printf(x3 + 65, forecast_y + 55, id(font_tiny), low_color3, "%.0f°", low3);
        }
        
        // Day 4
        int x4 = x3 + forecast_spacing;
        if (id(forecast_day4_name).has_state() && id(forecast_day4_high).has_state() && id(forecast_day4_low).has_state()) {
          it.printf(x4, forecast_y, id(font_body_small), COLOR_BLACK, TextAlign::TOP_LEFT, 
                   "%s", id(forecast_day4_name).state.c_str());
          it.printf(x4 + 15, forecast_y + 25, id(font_mdi_medium), COLOR_BLACK, 
                   "%s", get_forecast_icon(id(forecast_day4_condition).state));
          
          float high4 = id(forecast_day4_high).state;
          float low4 = id(forecast_day4_low).state;
          Color high_color4 = (high4 > 80) ? COLOR_RED : COLOR_BLACK;
          Color low_color4 = (low4 < 32) ? COLOR_BLUE : COLOR_BLACK;
          
          it.printf(x4 + 65, forecast_y + 30, id(font_body_small), high_color4, "%.0f°", high4);
          it.printf(x4 + 65, forecast_y + 55, id(font_tiny), low_color4, "%.0f°", low4);
        }
        
        // Day 5
        int x5 = x4 + forecast_spacing;
        if (id(forecast_day5_name).has_state() && id(forecast_day5_high).has_state() && id(forecast_day5_low).has_state()) {
          it.printf(x5, forecast_y, id(font_body_small), COLOR_BLACK, TextAlign::TOP_LEFT, 
                   "%s", id(forecast_day5_name).state.c_str());
          it.printf(x5 + 15, forecast_y + 25, id(font_mdi_medium), COLOR_BLACK, 
                   "%s", get_forecast_icon(id(forecast_day5_condition).state));
          
          float high5 = id(forecast_day5_high).state;
          float low5 = id(forecast_day5_low).state;
          Color high_color5 = (high5 > 80) ? COLOR_RED : COLOR_BLACK;
          Color low_color5 = (low5 < 32) ? COLOR_BLUE : COLOR_BLACK;
          
          it.printf(x5 + 65, forecast_y + 30, id(font_body_small), high_color5, "%.0f°", high5);
          it.printf(x5 + 65, forecast_y + 55, id(font_tiny), low_color5, "%.0f°", low5);
        }

      } else if (id(display_page) == 1) {
        // Page 2: Empty for now
        it.print(400, 240, id(font_header_bold), COLOR_BLACK, TextAlign::CENTER, "Page 2");
        it.print(400, 280, id(font_body_medium), COLOR_BLACK, TextAlign::CENTER, "(Empty - Add content later)");
        
      } else if (id(display_page) == 2) {
        // Page 3: Empty for now
        it.print(400, 240, id(font_header_bold), COLOR_BLACK, TextAlign::CENTER, "Page 3");
        it.print(400, 280, id(font_body_medium), COLOR_BLACK, TextAlign::CENTER, "(Empty - Add content later)");
      }
