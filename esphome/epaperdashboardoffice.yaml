esphome:
  name: epaperdashboardoffice
  friendly_name: epaperDashboardOffice
  on_boot:
    priority: 600
    then:
      - output.turn_on: bsp_battery_enable
      - delay: 200ms
      - component.update: epaper_display
      - script.execute: manage_run_and_sleep

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_key
  services:
    - service: play_tone
      variables:
        melody: string
      then:
        - rtttl.play: !lambda 'return melody;'
    - service: beep_short
      then:
        - rtttl.play: "beep:d=32,o=5,b=200:16e6"
    - service: beep_ok
      then:
        - rtttl.play: "ok:d=16,o=5,b=200:e6"
    - service: beep_error
      then:
        - rtttl.play: "error:d=16,o=5,b=200:c6"

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid2
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Epaperdashboardoffice"
    password: !secret ap_password

captive_portal:

# ============================================================================
# ▼▼▼ START: HARDWARE SECTIONS - COPY FROM HERE ▼▼▼
# ============================================================================
# Copy everything between the ▼▼▼ START and ▲▲▲ END markers
# Paste it in your ESPHome config AFTER the "captive_portal:" line
# ============================================================================

psram:
  mode: octal
  speed: 80MHz

time:
  - platform: homeassistant
    id: ha_time

i2c:
  sda: GPIO19
  scl: GPIO20
  scan: true

spi:
  clk_pin: GPIO7
  mosi_pin: GPIO9

output:
  - platform: gpio
    pin: GPIO21
    id: bsp_battery_enable

  - platform: ledc
    pin: GPIO45
    id: buzzer_output

rtttl:
  id: reterminal_buzzer
  output: buzzer_output

sensor:
  # Existing hardware sensors
  - platform: sht4x
    temperature:
      name: "reTerminal Onboard Temperature"
      id: onboard_temperature
      accuracy_decimals: 2
      filters:
        - round: 2
    humidity:
      name: "reTerminal Onboard Humidity"
      id: onboard_humidity
      accuracy_decimals: 2
      filters:
        - round: 2
    address: 0x44
    update_interval: 60s

  - platform: adc
    pin: GPIO1
    name: "Battery Voltage"
    id: battery_voltage
    update_interval: 60s
    attenuation: 12db
    accuracy_decimals: 2
    filters:
      - multiply: 2.0
      - round: 2

  - platform: template
    name: "Battery Level"
    id: battery_level
    lambda: 'return id(battery_voltage).state;'
    unit_of_measurement: "%"
    device_class: battery
    update_interval: 60s
    accuracy_decimals: 0
    filters:
      - calibrate_linear:
          - 3.27 -> 0.0
          - 4.15 -> 100.0
      - clamp:
          min_value: 0
          max_value: 100
      - round: 0
  # Home Assistant sensors
  - platform: homeassistant
    id: sensor_dining_room_current_temperature
    entity_id: sensor.dining_room_current_temperature
    internal: true
    accuracy_decimals: 1
  - platform: homeassistant
    id: sensor_ecowitt_weather_station_humidity
    entity_id: sensor.ecowitt_weather_station_humidity
    internal: true
  - platform: homeassistant
    id: sensor_ecowitt_weather_station_outdoor_temperature
    entity_id: sensor.ecowitt_weather_station_outdoor_temperature
    internal: true


# ============================================================================
# ▲▲▲ END: HARDWARE SECTIONS - COPY UNTIL HERE ▲▲▲
# ============================================================
# Generated by reTerminal Dashboard Designer
# Target device: reTerminal E1001 (800x480 epaper)
#
# Usage:
# 1. Ensure you already have a working base ESPHome config for your device:
#    - Includes: esphome, esp32, wifi, api, ota, logger
#    - Uses the correct board for the reTerminal E1001
# 2. Paste this snippet BELOW your existing base config.
# 3. Do NOT duplicate esphome:, wifi:, api:, ota:, logger: sections.
# 4. If you already define conflicting ids (e.g. epaper_display), adjust accordingly.
#
# WARNING:
# - This is an MVP generator. Review the result before flashing.
# - Keep this snippet under version control to track your layout changes.
# ============================================================

globals:
  # Current page index (0-based)
  - id: display_page
    type: int
    restore_value: true
    initial_value: '0'

  # Battery icon glyph (optional usage in display lambda)
  - id: battery_glyph
    type: std::string
    restore_value: no
    initial_value: '"\U000F0079"'

  # Default page refresh interval (seconds)
  - id: page_refresh_default_s
    type: int
    restore_value: no
    initial_value: '900'

  # Current computed refresh interval (seconds)
  - id: page_refresh_current_s
    type: int
    restore_value: no
    initial_value: '900'


font:
  - file: "gfonts://Roboto@400"
    id: font_axis
    size: 10

  - file: "gfonts://Roboto@400"
    id: font_small
    size: 19

  - file: "gfonts://Roboto@500"
    id: font_normal
    size: 22

  - file: "gfonts://Roboto@700"
    id: font_header
    size: 24

  # Custom text fonts for specific sizes and weights
  - file: "gfonts://Roboto@500"
    id: font_text_14_400
    size: 14
  - file: "gfonts://Roboto@500"
    id: font_text_20_400
    size: 20
  - file: "gfonts://Roboto@600"
    id: font_text_20_500
    size: 20
  - file: "gfonts://Roboto@800"
    id: font_text_25_800
    size: 25
  - file: "gfonts://Roboto@700"
    id: font_text_28_700
    size: 28

  # Material Design Icons for icon widgets
  # Copy materialdesignicons-webfont.ttf to your ESPHome fonts folder
  - file: fonts/materialdesignicons-webfont.ttf
    id: font_mdi_22
    size: 22
    glyphs: ["\U000F0024", "\U000F050F", "\U000F058E", "\U000F0590", "\U000F0591", "\U000F0594", "\U000F0595", "\U000F0596", "\U000F0597", "\U000F0598", "\U000F0599", "\U000F067F", "\U000F06A1", "\U000F0E6E", "\U000F0F2F", "\U000F0F32", "\U000F192C"]
  - file: fonts/materialdesignicons-webfont.ttf
    id: font_mdi_48
    size: 48
    glyphs: ["\U000F0024", "\U000F050F", "\U000F058E", "\U000F0590", "\U000F0591", "\U000F0594", "\U000F0595", "\U000F0596", "\U000F0597", "\U000F0598", "\U000F0599", "\U000F067F", "\U000F06A1", "\U000F0E6E", "\U000F0F2F", "\U000F0F32", "\U000F192C"]

text_sensor:
  - platform: homeassistant
    id: sensor_dining_room_current_humidity
    entity_id: sensor.dining_room_current_humidity
    internal: true
  - platform: homeassistant
    id: weather_forecast_home
    entity_id: weather.forecast_home
    internal: true

# No online_image widgets configured

button:
  - platform: template
    name: "reTerminal Next Page"
    id: reterminal_next_page
    on_press:
      - lambda: |-
          int pages = 3;
          id(display_page) = (id(display_page) + 1) % pages;

  - platform: template
    name: "reTerminal Previous Page"
    id: reterminal_prev_page
    on_press:
      - lambda: |-
          int pages = 3;
          id(display_page) = (id(display_page) - 1 + pages) % pages;

  - platform: template
    name: "reTerminal Refresh Display"
    id: reterminal_refresh_display
    on_press:
      - component.update: epaper_display

  - platform: template
    name: "reTerminal Go to Page 1"
    id: reterminal_goto_page_0
    on_press:
      - lambda: 'id(display_page) = 0;'
      - component.update: epaper_display
  - platform: template
    name: "reTerminal Go to Page 2"
    id: reterminal_goto_page_1
    on_press:
      - lambda: 'id(display_page) = 1;'
      - component.update: epaper_display
  - platform: template
    name: "reTerminal Go to Page 3"
    id: reterminal_goto_page_2
    on_press:
      - lambda: 'id(display_page) = 2;'
      - component.update: epaper_display

  # Buzzer control buttons (hardware feature)
  - platform: template
    name: "reTerminal Beep"
    id: reterminal_beep
    on_press:
      - rtttl.play: "beep:d=32,o=5,b=200:16e6"

  - platform: template
    name: "reTerminal Beep Error"
    id: reterminal_beep_error
    on_press:
      - rtttl.play: "error:d=16,o=5,b=200:c6"

  - platform: template
    name: "reTerminal Play Star Wars"
    id: reterminal_star_wars
    on_press:
      - rtttl.play: "StarWars:d=4,o=5,b=45:32p,32f,32f,32f,8a#.,8f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32d#,8c6,32p,32f,32f,32f,8a#.,8f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32d#,8c6"


script:
  - id: manage_run_and_sleep
    mode: restart
    then:
      - wait_until:
          condition:
            lambda: 'return id(ha_time).now().is_valid();'
          timeout: 120s
      
      # Sleep mode disabled
      - if:
          condition:
            lambda: 'return false;'
          then:
            - delay: 1s
          else:
            - lambda: |-
                int page = id(display_page);
                int interval = id(page_refresh_default_s);
                switch (page) {
                  default:
                    break;
                }
                if (interval < 60) {
                  interval = 60;
                }
                id(page_refresh_current_s) = interval;
                ESP_LOGI("refresh", "Next refresh in %d seconds for page %d", interval, page);
            
            
            - component.update: epaper_display
            - delay: !lambda 'return id(page_refresh_current_s) * 1000;'
            - script.execute: manage_run_and_sleep


# No graph widgets configured

display:
  - platform: waveshare_epaper
    id: epaper_display
    model: 7.50inv2
    cs_pin: GPIO10
    dc_pin: GPIO11
    reset_pin:
      number: GPIO12
      inverted: false
    busy_pin:
      number: GPIO13
      inverted: true
    update_interval: never
    lambda: |-
      it.fill(Color(0));

      if (id(display_page) == 0) {
        // widget:text id:w_1763752180491_722 type:text x:306 y:32 w:189 h:28 text:"Sussex House" font_size:25 font_family:Inter font_weight:800 weight:800 color:black font_style:regular
        it.print(306, 32, id(font_text_25_800), COLOR_ON, "Sussex House");
        // widget:datetime id:w_1763752241459_7193 type:datetime x:295 y:60 w:205 h:33 format:date_only time_font:28 date_font:20 color:black font_family:Inter
        it.strftime(397, 60, id(font_text_20_400), COLOR_ON, TextAlign::TOP_CENTER, "%a, %b %d", id(ha_time).now());        
        // widget:weather_icon id:w_1763752381680_5445 type:weather_icon x:16 y:40 w:48 h:48 ent:weather.forecast_home size:48 color:black
        {
          std::string state = id(weather_forecast_home).state;
          const char* icon = "\U000F0591"; // default sunny
          if (state == "clear-night") icon = "\U000F0594";
          else if (state == "cloudy") icon = "\U000F0595";
          else if (state == "fog") icon = "\U000F192C";
          else if (state == "hail") icon = "\U000F0E6E";
          else if (state == "lightning") icon = "\U000F0598";
          else if (state == "lightning-rainy") icon = "\U000F067F";
          else if (state == "partlycloudy") icon = "\U000F0599";
          else if (state == "pouring") icon = "\U000F06A1";
          else if (state == "rainy") icon = "\U000F0596";
          else if (state == "snowy") icon = "\U000F0590";
          else if (state == "snowy-rainy") icon = "\U000F0F32";
          else if (state == "sunny") icon = "\U000F0591";
          else if (state == "windy") icon = "\U000F0597";
          else if (state == "windy-variant") icon = "\U000F0F2F";
          else if (state == "exceptional") icon = "\U000F0024";
          it.printf(16, 40, id(font_mdi_48), COLOR_ON, "%s", icon);
        }
        // widget:sensor_text id:w_1763752402023_8192 type:sensor_text x:88 y:44 w:164 h:46 ent:weather.forecast_home title:"Current Conditions" label_font:14 value_font:20 format:label_newline_value font_family:Inter font_weight:400 precision:-1 local:false
        it.printf(88, 44, id(font_text_20_400), COLOR_ON, "Current Conditions");
        it.printf(88, 62, id(font_text_20_400), COLOR_ON, "%s", id(weather_forecast_home).state.c_str());
        // widget:sensor_text id:w_1763752665996_7875 type:sensor_text x:675 y:107 w:120 h:40 ent:sensor.dining_room_current_humidity title:"Dining Room  Current Humidity" label_font:14 value_font:20 format:value_only font_family:Inter font_weight:400 precision:-1 local:false
        it.printf(675, 107, id(font_text_20_400), COLOR_ON, "%s", id(sensor_dining_room_current_humidity).state.c_str());
        // widget:sensor_text id:w_1763752681116_9867 type:sensor_text x:675 y:75 w:90 h:30 ent:sensor.dining_room_current_temperature title:"Dining Room" label_font:20 value_font:20 format:value_only font_family:Inter font_weight:400 precision:1 local:false
        it.printf(675, 75, id(font_text_20_400), COLOR_ON, "%.1f", id(sensor_dining_room_current_temperature).state);
        // widget:text id:w_1763752772048_2914 type:text x:577 y:40 w:197 h:29 text:"Indoor Conditions" font_size:20 font_family:Inter font_weight:500 weight:500 color:black font_style:regular
        it.print(577, 40, id(font_text_20_500), COLOR_ON, "Indoor Conditions");
        // widget:icon id:w_1763752985044_2019 type:icon x:636 y:73 w:32 h:30 code:F050F size:22 color:black
        it.print(636, 73, id(font_mdi_22), COLOR_ON, "󰔏");
        // widget:icon id:w_1763753043337_5944 type:icon x:637 y:101 w:32 h:30 code:F058E size:22 color:black
        it.print(637, 101, id(font_mdi_22), COLOR_ON, "󰖎");
        // widget:text id:w_1763753076588_1350 type:text x:570 y:75 w:66 h:41 text:"Dining" font_size:20 font_family:Inter font_weight:400 weight:400 color:black font_style:regular
        it.print(570, 75, id(font_text_20_400), COLOR_ON, "Dining");
        // widget:line id:w_1763753140186_1566 type:line x:556 y:147 w:213 h:10 stroke:1 color:gray
        it.line(556, 147, 556+213, 147, COLOR_ON);
        // widget:sensor_text id:w_1763753323899_784 type:sensor_text x:16 y:92 w:102 h:36 ent:sensor.ecowitt_weather_station_outdoor_temperature title:"ecowitt weather station Outdoor Temperature" label_font:14 value_font:20 format:value_only font_family:Inter font_weight:400 precision:-1 local:false
        it.printf(16, 92, id(font_text_20_400), COLOR_ON, "%.1f°F", id(sensor_ecowitt_weather_station_outdoor_temperature).state);
        // widget:sensor_text id:w_1763753366885_535 type:sensor_text x:182 y:94 w:70 h:36 ent:sensor.ecowitt_weather_station_humidity title:"ecowitt weather station Humidity" label_font:14 value_font:20 format:value_only font_family:Inter font_weight:400 precision:-1 local:false
        it.printf(182, 94, id(font_text_20_400), COLOR_ON, "%.0f%%", id(sensor_ecowitt_weather_station_humidity).state);

       // widget:text id:w_1763771007513_3097 type:text x:570 y:105 w:67 h:28 text:"Room" font_size:20 font_family:Inter font_weight:400 weight:400 color:black font_style:regular
        it.print(570, 105, id(font_text_20_400), COLOR_ON, "Room");
      }
      if (id(display_page) == 1) {
        // Page 1: no widgets configured.
      }
      if (id(display_page) == 2) {
        // Page 2: no widgets configured.
      }